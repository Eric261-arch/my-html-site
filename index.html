<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Budget - Financial Management App</title>
    <meta name="description" content="Manage your finances, split bills, and track expenses with Smart Budget">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU21hcnQgQnVkZ2V0IiAic2hvcnRfbmFtZSI6IlNtYXJ0QnVkZ2V0IiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vdmlhLnBsYWNlaG9sZGVyLmNvbS8xOTIiLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJ0aGVtZV9jb2xvciI6IiM2NjdlZWEiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiJ9">
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            touch-action: manipulation;
        }
        
        .gradient-bg { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        }
        
        .glass { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .fade-in { 
            animation: fadeIn 0.3s ease-in; 
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .notification-dot::after { 
            content: ''; 
            position: absolute; 
            top: -2px; 
            right: -2px; 
            width: 8px; 
            height: 8px; 
            background: #ef4444; 
            border-radius: 50%; 
        }

        .btn {
            min-height: 44px;
            min-width: 44px;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            border: none;
        }

        .btn-success {
            background: #10b981;
            color: white;
            border: none;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
            border: none;
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            overflow: hidden;
        }

        .card-mobile {
            margin-bottom: 16px;
            padding: 16px;
        }

        .grid-responsive {
            display: grid;
            gap: 16px;
            grid-template-columns: 1fr;
        }

        @media (min-width: 640px) {
            .grid-responsive {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .grid-responsive {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .form-input {
            width: 100%;
            min-height: 44px;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #f59e0b;
            color: white;
            text-align: center;
            padding: 8px;
            z-index: 9999;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .offline-banner.show {
            transform: translateY(0);
        }

        .tab-nav {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .tab-nav::-webkit-scrollbar {
            display: none;
        }

        .action-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 16px 16px 0 0;
            padding: 20px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .action-sheet.show {
            transform: translateY(0);
        }

        /* Session timeout banner */
        .session-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #dc2626;
            color: white;
            text-align: center;
            padding: 12px;
            z-index: 9999;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .session-banner.show {
            transform: translateY(0);
        }

        /* Session warning modal */
        .session-warning {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            items-center;
            justify-content: center;
            z-index: 9998;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .session-warning.show {
            opacity: 1;
            visibility: visible;
        }

        .session-warning-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            margin: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="offline-banner" class="offline-banner">
        <span>You're offline. Changes will sync when connection is restored.</span>
    </div>
    
    <div id="session-banner" class="session-banner">
        <span>Session timed out for security. Please sign in again.</span>
    </div>

    <!-- Session Warning Modal -->
    <div id="session-warning" class="session-warning">
        <div class="session-warning-content">
            <div class="text-center mb-4">
                <svg class="w-16 h-16 text-yellow-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <h3 class="text-lg font-bold text-gray-800">Session Expiring Soon</h3>
                <p class="text-gray-600 mt-2">Your session will expire in <span id="session-countdown">60</span> seconds for security.</p>
            </div>
            <div class="flex space-x-3">
                <button id="extend-session" class="flex-1 btn btn-primary">
                    Stay Logged In
                </button>
                <button id="logout-now" class="flex-1 btn btn-secondary">
                    Logout Now
                </button>
            </div>
        </div>
    </div>
    
    <div id="app"></div>

    <script>
        // Enhanced Security & Session Management
        class SecurityManager {
            constructor() {
                this.SESSION_TIMEOUT = 5 * 60 * 1000; // 5 minutes
                this.WARNING_TIME = 60 * 1000; // Show warning 1 minute before timeout
                this.CHECK_INTERVAL = 1000; // Check every second
                
                this.sessionTimer = null;
                this.warningTimer = null;
                this.checkInterval = null;
                this.lastActivity = null;
                this.isWarningShown = false;
                this.countdownInterval = null;
                
                this.init();
            }

            init() {
                this.setupActivityListeners();
                this.setupVisibilityHandler();
                this.setupWarningHandlers();
                this.startSessionCheck();
                this.updateLastActivity();
            }

            setupActivityListeners() {
                // Track user activity events
                const events = [
                    'mousedown', 'mousemove', 'keypress', 'scroll', 
                    'touchstart', 'click', 'focus', 'blur'
                ];
                
                events.forEach(event => {
                    document.addEventListener(event, () => {
                        this.updateLastActivity();
                    }, { passive: true });
                });
            }

            setupVisibilityHandler() {
                // Handle page visibility changes (app switching)
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible') {
                        // Check if session expired while away
                        this.checkSessionOnReturn();
                    } else {
                        // Store timestamp when leaving
                        this.storeLastActivity();
                    }
                });

                // Handle page focus/blur for browsers
                window.addEventListener('focus', () => {
                    this.checkSessionOnReturn();
                });

                window.addEventListener('beforeunload', () => {
                    this.storeLastActivity();
                });
            }

            setupWarningHandlers() {
                document.getElementById('extend-session').addEventListener('click', () => {
                    this.extendSession();
                });

                document.getElementById('logout-now').addEventListener('click', () => {
                    this.forceLogout();
                });
            }

            updateLastActivity() {
                this.lastActivity = Date.now();
                this.storeLastActivity();
                
                if (this.isWarningShown) {
                    this.hideWarning();
                }
                
                this.resetTimers();
            }

            storeLastActivity() {
                if (this.lastActivity) {
                    localStorage.setItem('smartbudget_lastActivity', this.lastActivity.toString());
                }
            }

            getStoredLastActivity() {
                const stored = localStorage.getItem('smartbudget_lastActivity');
                return stored ? parseInt(stored) : null;
            }

            checkSessionOnReturn() {
                const storedActivity = this.getStoredLastActivity();
                if (storedActivity) {
                    const timeSinceActivity = Date.now() - storedActivity;
                    
                    if (timeSinceActivity >= this.SESSION_TIMEOUT) {
                        this.sessionExpired();
                        return;
                    }
                    
                    this.lastActivity = storedActivity;
                    this.resetTimers();
                }
            }

            startSessionCheck() {
                this.checkInterval = setInterval(() => {
                    if (!this.lastActivity) return;
                    
                    const timeSinceActivity = Date.now() - this.lastActivity;
                    
                    if (timeSinceActivity >= this.SESSION_TIMEOUT) {
                        this.sessionExpired();
                    } else if (timeSinceActivity >= (this.SESSION_TIMEOUT - this.WARNING_TIME) && !this.isWarningShown) {
                        this.showWarning();
                    }
                }, this.CHECK_INTERVAL);
            }

            resetTimers() {
                if (this.sessionTimer) {
                    clearTimeout(this.sessionTimer);
                }
                if (this.warningTimer) {
                    clearTimeout(this.warningTimer);
                }
            }

            showWarning() {
                this.isWarningShown = true;
                const modal = document.getElementById('session-warning');
                modal.classList.add('show');
                
                this.startCountdown();
            }

            hideWarning() {
                this.isWarningShown = false;
                const modal = document.getElementById('session-warning');
                modal.classList.remove('show');
                
                if (this.countdownInterval) {
                    clearInterval(this.countdownInterval);
                    this.countdownInterval = null;
                }
            }

            startCountdown() {
                const countdownElement = document.getElementById('session-countdown');
                
                this.countdownInterval = setInterval(() => {
                    if (!this.lastActivity) return;
                    
                    const timeSinceActivity = Date.now() - this.lastActivity;
                    const timeRemaining = this.SESSION_TIMEOUT - timeSinceActivity;
                    const secondsRemaining = Math.max(0, Math.ceil(timeRemaining / 1000));
                    
                    countdownElement.textContent = secondsRemaining;
                    
                    if (secondsRemaining <= 0) {
                        this.sessionExpired();
                    }
                }, 1000);
            }

            extendSession() {
                this.updateLastActivity();
                this.hideWarning();
            }

            forceLogout() {
                this.hideWarning();
                this.sessionExpired();
            }

            sessionExpired() {
                // Clear all session data
                this.clearSession();
                
                // Show session expired banner
                this.showSessionExpiredBanner();
                
                // Force logout
                if (window.app) {
                    window.app.handleSessionExpired();
                }
            }

            showSessionExpiredBanner() {
                const banner = document.getElementById('session-banner');
                banner.classList.add('show');
                
                setTimeout(() => {
                    banner.classList.remove('show');
                }, 5000);
            }

            clearSession() {
                // Clear session-related data
                localStorage.removeItem('smartbudget_currentUser');
                localStorage.removeItem('smartbudget_lastActivity');
                
                // Clear timers
                if (this.sessionTimer) clearTimeout(this.sessionTimer);
                if (this.warningTimer) clearTimeout(this.warningTimer);
                if (this.checkInterval) clearInterval(this.checkInterval);
                if (this.countdownInterval) clearInterval(this.countdownInterval);
                
                this.hideWarning();
            }

            isSessionValid() {
                const storedActivity = this.getStoredLastActivity();
                if (!storedActivity) return false;
                
                const timeSinceActivity = Date.now() - storedActivity;
                return timeSinceActivity < this.SESSION_TIMEOUT;
            }

            destroy() {
                this.clearSession();
            }
        }

        // Enhanced Storage Service with security integration
        class StorageService {
            constructor() {
                this.prefix = 'smartbudget_';
                this.syncQueue = [];
                this.isOnline = navigator.onLine;
                this.initializeDB();
                this.setupOfflineHandling();
            }

            initializeDB() {
                if (!this.get('initialized')) {
                    this.set('users', []);
                    this.set('currentUser', null);
                    this.set('incomes', []);
                    this.set('bills', []);
                    this.set('linkedAccounts', []);
                    this.set('notifications', []);
                    this.set('transactions', []);
                    this.set('syncQueue', []);
                    this.set('initialized', true);
                }
                this.syncQueue = this.get('syncQueue') || [];
            }

            setupOfflineHandling() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.showOfflineBanner(false);
                    this.processSyncQueue();
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.showOfflineBanner(true);
                });
            }

            showOfflineBanner(show) {
                const banner = document.getElementById('offline-banner');
                banner.classList.toggle('show', show);
            }

            get(key) {
                const data = localStorage.getItem(this.prefix + key);
                return data ? JSON.parse(data) : null;
            }

            set(key, value) {
                localStorage.setItem(this.prefix + key, JSON.stringify(value));
                return value;
            }

            update(key, updateFn) {
                const current = this.get(key);
                const updated = updateFn(current || []);
                return this.set(key, updated);
            }

            delete(key) {
                localStorage.removeItem(this.prefix + key);
            }

            // Enhanced authentication with security checks
            authenticateUser(email, password) {
                const users = this.get('users') || [];
                const user = users.find(u => u.email === email && u.password === password);
                
                if (user) {
                    // Log authentication event
                    this.logTransaction('user_login', { 
                        userId: user.id, 
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent 
                    });
                }
                
                return user;
            }

            // Secure logout that clears sensitive data
            secureLogout() {
                const currentUser = this.get('currentUser');
                if (currentUser) {
                    this.logTransaction('user_logout', { 
                        userId: currentUser.id, 
                        timestamp: new Date().toISOString(),
                        reason: 'manual'
                    });
                }
                
                this.set('currentUser', null);
                this.delete('lastActivity');
            }

            // Session expired logout
            sessionExpiredLogout() {
                const currentUser = this.get('currentUser');
                if (currentUser) {
                    this.logTransaction('user_logout', { 
                        userId: currentUser.id, 
                        timestamp: new Date().toISOString(),
                        reason: 'session_timeout'
                    });
                }
                
                this.set('currentUser', null);
                this.delete('lastActivity');
            }

            addToSyncQueue(operation) {
                this.syncQueue.push({
                    id: Date.now().toString(),
                    operation,
                    timestamp: new Date().toISOString()
                });
                this.set('syncQueue', this.syncQueue);
            }

            async processSyncQueue() {
                if (!this.isOnline || this.syncQueue.length === 0) return;
                
                console.log('Processing sync queue...');
                this.syncQueue = [];
                this.set('syncQueue', []);
            }

            createUser(userData) {
                const users = this.get('users') || [];
                const newUser = {
                    id: Date.now().toString(),
                    ...userData,
                    createdAt: new Date().toISOString(),
                    creditScore: Math.floor(Math.random() * 200) + 600,
                    settings: {
                        privateMode: false,
                        notifications: true,
                        currency: 'USD'
                    }
                };
                users.push(newUser);
                this.set('users', users);
                return newUser;
            }

            addIncome(incomeData) {
                const incomes = this.get('incomes') || [];
                const newIncome = {
                    id: Date.now().toString(),
                    ...incomeData,
                    createdAt: new Date().toISOString()
                };
                incomes.push(newIncome);
                this.set('incomes', incomes);
                this.addToSyncQueue({ type: 'ADD_INCOME', data: newIncome });
                return newIncome;
            }

            updateIncome(incomeId, updates) {
                return this.update('incomes', incomes => {
                    const index = incomes.findIndex(i => i.id === incomeId);
                    if (index !== -1) {
                        incomes[index] = { ...incomes[index], ...updates, updatedAt: new Date().toISOString() };
                        this.addToSyncQueue({ type: 'UPDATE_INCOME', id: incomeId, data: updates });
                    }
                    return incomes;
                });
            }

            deleteIncome(incomeId) {
                return this.update('incomes', incomes => {
                    const filtered = incomes.filter(i => i.id !== incomeId);
                    this.addToSyncQueue({ type: 'DELETE_INCOME', id: incomeId });
                    return filtered;
                });
            }

            addBill(billData) {
                const bills = this.get('bills') || [];
                const newBill = {
                    id: Date.now().toString(),
                    ...billData,
                    createdAt: new Date().toISOString(),
                    paid: false,
                    paidBy: []
                };
                bills.push(newBill);
                this.set('bills', bills);
                this.addToSyncQueue({ type: 'ADD_BILL', data: newBill });
                this.checkUpcomingBills();
                this.scheduleNotification(newBill);
                return newBill;
            }

            updateBill(billId, updates) {
                const result = this.update('bills', bills => {
                    const index = bills.findIndex(b => b.id === billId);
                    if (index !== -1) {
                        bills[index] = { ...bills[index], ...updates, updatedAt: new Date().toISOString() };
                        this.addToSyncQueue({ type: 'UPDATE_BILL', id: billId, data: updates });
                        
                        if (updates.dueDate) {
                            this.scheduleNotification(bills[index]);
                        }
                    }
                    return bills;
                });
                return result;
            }

            deleteBill(billId) {
                return this.update('bills', bills => {
                    const filtered = bills.filter(b => b.id !== billId);
                    this.addToSyncQueue({ type: 'DELETE_BILL', id: billId });
                    return filtered;
                });
            }

            checkUpcomingBills() {
                const bills = this.get('bills') || [];
                const notifications = this.get('notifications') || [];
                const today = new Date();
                
                bills.forEach(bill => {
                    if (!bill.paid) {
                        const dueDate = new Date(bill.dueDate);
                        const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                        
                        if (daysUntil <= 3 && daysUntil >= 0) {
                            const exists = notifications.find(n => 
                                n.type === 'bill_reminder' && n.billId === bill.id
                            );
                            
                            if (!exists) {
                                notifications.push({
                                    id: Date.now().toString(),
                                    type: 'bill_reminder',
                                    billId: bill.id,
                                    message: `${bill.name} due in ${daysUntil} days`,
                                    createdAt: new Date().toISOString(),
                                    read: false
                                });
                            }
                        }
                    }
                });
                
                this.set('notifications', notifications);
            }

            async scheduleNotification(bill) {
                if (!('Notification' in window)) return;
                
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') return;

                const dueDate = new Date(bill.dueDate);
                const today = new Date();
                const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                
                if (daysUntil === 1) {
                    setTimeout(() => {
                        new Notification('Bill Reminder', {
                            body: `${bill.name} is due tomorrow ($${bill.amount})`,
                            icon: '/icon-192x192.png',
                            badge: '/icon-192x192.png',
                            tag: `bill-${bill.id}`,
                            requireInteraction: true
                        });
                    }, 1000);
                }
            }

            logTransaction(type, data) {
                const transactions = this.get('transactions') || [];
                const transaction = {
                    id: Date.now().toString(),
                    type,
                    data,
                    timestamp: new Date().toISOString()
                };
                transactions.push(transaction);
                this.set('transactions', transactions);
                this.addToSyncQueue({ type: 'LOG_TRANSACTION', data: transaction });
            }
        }

        // Initialize storage and security
        const storage = new StorageService();
        const security = new SecurityManager();

        // Enhanced Main App Class with security integration
        class SmartBudgetApp {
            constructor() {
                this.currentUser = null;
                this.currentView = 'login';
                this.activeTab = 'dashboard';
                this.privateMode = false;
                this.loading = false;
                this.sessionExpiredMessage = '';
                this.init();
            }

            async init() {
                // Check session validity before setting current user
                const storedUser = storage.get('currentUser');
                if (storedUser && security.isSessionValid()) {
                    this.currentUser = storedUser;
                    this.currentView = 'app';
                } else if (storedUser) {
                    // Session expired, clear data and show message
                    storage.sessionExpiredLogout();
                    this.sessionExpiredMessage = 'Session timed out for security. Please sign in again.';
                    this.currentView = 'login';
                }
                
                await this.requestNotificationPermission();
                this.render();
                this.attachEventListeners();
                
                // Check for bills periodically (only if logged in)
                setInterval(() => {
                    if (this.currentUser && security.isSessionValid()) {
                        storage.checkUpcomingBills();
                    }
                }, 60000);
                
                // Make app available globally for security manager
                window.app = this;
            }

            async requestNotificationPermission() {
                if ('Notification' in window && 'serviceWorker' in navigator) {
                    const permission = await Notification.requestPermission();
                    console.log('Notification permission:', permission);
                }
            }

            handleSessionExpired() {
                this.currentUser = null;
                this.currentView = 'login';
                this.sessionExpiredMessage = 'Session timed out for security. Please sign in again.';
                this.render();
            }

            attachEventListeners() {
                document.addEventListener('click', (e) => {
                    if (e.target.matches('[data-action]') || e.target.closest('[data-action]')) {
                        const element = e.target.matches('[data-action]') ? e.target : e.target.closest('[data-action]');
                        const action = element.dataset.action;
                        this.handleAction(action, element);
                    }
                });

                document.addEventListener('submit', (e) => {
                    if (e.target.matches('[data-form]')) {
                        e.preventDefault();
                        const formType = e.target.dataset.form;
                        this.handleFormSubmit(formType, new FormData(e.target));
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeModal();
                    }
                });
            }

            setLoading(isLoading) {
                this.loading = isLoading;
                const app = document.getElementById('app');
                app.classList.toggle('loading', isLoading);
            }

            async handleAction(action, element) {
                // Check session validity for authenticated actions
                if (this.currentUser && !security.isSessionValid()) {
                    this.handleSessionExpired();
                    return;
                }

                this.setLoading(true);
                
                try {
                    switch(action) {
                        case 'logout':
                            storage.secureLogout();
                            security.clearSession();
                            this.currentUser = null;
                            this.currentView = 'login';
                            this.sessionExpiredMessage = '';
                            this.render();
                            break;
                        
                        case 'toggle-private':
                            this.privateMode = !this.privateMode;
                            this.render();
                            break;
                        
                        case 'switch-tab':
                            this.activeTab = element.dataset.tab;
                            this.render();
                            break;
                        
                        case 'show-modal':
                            this.showModal(element.dataset.modal, element.dataset.id);
                            break;
                        
                        case 'close-modal':
                            this.closeModal();
                            break;
                        
                        case 'mark-paid':
                            await this.markBillPaid(element.dataset.billId);
                            break;
                        
                        case 'dismiss-notification':
                            await this.dismissNotification(element.dataset.notificationId);
                            break;
                        
                        case 'delete-income':
                            await this.deleteIncome(element.dataset.incomeId);
                            break;
                        
                        case 'delete-bill':
                            await this.deleteBill(element.dataset.billId);
                            break;
                        
                        case 'switch-to-signup':
                            document.getElementById('login-form').style.display = 'none';
                            document.getElementById('signup-form').style.display = 'block';
                            this.sessionExpiredMessage = '';
                            break;
                        
                        case 'switch-to-login':
                            document.getElementById('signup-form').style.display = 'none';
                            document.getElementById('login-form').style.display = 'block';
                            break;
                    }
                } finally {
                    this.setLoading(false);
                }
            }

            async handleFormSubmit(formType, formData) {
                this.setLoading(true);
                const data = Object.fromEntries(formData);
                
                try {
                    switch(formType) {
                        case 'login':
                            const user = storage.authenticateUser(data.email, data.password);
                            if (user) {
                                this.currentUser = user;
                                storage.set('currentUser', user);
                                security.updateLastActivity(); // Start new session
                                this.currentView = 'app';
                                this.sessionExpiredMessage = '';
                                this.render();
                            } else {
                                this.showError('Invalid credentials. Try creating a new account!');
                            }
                            break;
                        
                        case 'signup':
                            const newUser = storage.createUser({
                                name: data.name,
                                email: data.email,
                                password: data.password
                            });
                            this.currentUser = newUser;
                            storage.set('currentUser', newUser);
                            security.updateLastActivity(); // Start new session
                            this.currentView = 'app';
                            this.sessionExpiredMessage = '';
                            this.render();
                            break;
                        
                        case 'add-income':
                        case 'edit-income':
                            // Check session before processing
                            if (!security.isSessionValid()) {
                                this.handleSessionExpired();
                                return;
                            }
                            
                            const incomeData = {
                                ...data,
                                amount: parseFloat(data.amount),
                                userId: this.currentUser.id
                            };
                            
                            if (formType === 'edit-income' && data.id) {
                                storage.updateIncome(data.id, incomeData);
                            } else {
                                storage.addIncome(incomeData);
                            }
                            this.closeModal();
                            this.render();
                            break;
                        
                        case 'add-bill':
                        case 'edit-bill':
                            // Check session before processing
                            if (!security.isSessionValid()) {
                                this.handleSessionExpired();
                                return;
                            }
                            
                            const billData = {
                                ...data,
                                amount: parseFloat(data.amount),
                                userShare: data.isSplit ? parseFloat(data.userShare) : 100,
                                userId: this.currentUser.id
                            };
                            
                            if (formType === 'edit-bill' && data.id) {
                                storage.updateBill(data.id, billData);
                            } else {
                                storage.addBill(billData);
                            }
                            this.closeModal();
                            this.render();
                            break;
                    }
                } catch (error) {
                    this.showError('An error occurred. Please try again.');
                    console.error(error);
                } finally {
                    this.setLoading(false);
                }
            }

            showError(message) {
                const toast = document.createElement('div');
                toast.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in';
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }

            async markBillPaid(billId) {
                if (!security.isSessionValid()) {
                    this.handleSessionExpired();
                    return;
                }
                
                storage.updateBill(billId, { paid: true, paidDate: new Date().toISOString() });
                storage.logTransaction('bill_paid', { billId, userId: this.currentUser.id });
                this.render();
            }

            async dismissNotification(notificationId) {
                const notifications = storage.get('notifications') || [];
                const filtered = notifications.filter(n => n.id !== notificationId);
                storage.set('notifications', filtered);
                this.render();
            }

            async deleteIncome(incomeId) {
                if (!security.isSessionValid()) {
                    this.handleSessionExpired();
                    return;
                }
                
                if (confirm('Are you sure you want to delete this income source?')) {
                    storage.deleteIncome(incomeId);
                    this.render();
                }
            }

            async deleteBill(billId) {
                if (!security.isSessionValid()) {
                    this.handleSessionExpired();
                    return;
                }
                
                if (confirm('Are you sure you want to delete this bill?')) {
                    storage.deleteBill(billId);
                    this.render();
                }
            }

            showModal(modalType, itemId = null) {
                if (!security.isSessionValid()) {
                    this.handleSessionExpired();
                    return;
                }
                
                const modalContent = this.getModalContent(modalType, itemId);
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 fade-in';
                modal.innerHTML = `
                    <div class="glass rounded-2xl p-6 w-full max-w-md max-h-screen overflow-y-auto">
                        ${modalContent}
                    </div>
                `;
                document.body.appendChild(modal);
                
                setTimeout(() => {
                    const firstInput = modal.querySelector('input, select, textarea');
                    if (firstInput) firstInput.focus();
                }, 100);
            }

            closeModal() {
                const modal = document.querySelector('.fixed.inset-0');
                if (modal) modal.remove();
            }

            getModalContent(type, itemId) {
                const isEdit = itemId !== null;
                let item = null;
                
                if (isEdit) {
                    if (type === 'income') {
                        const incomes = storage.get('incomes') || [];
                        item = incomes.find(i => i.id === itemId);
                    } else if (type === 'bill') {
                        const bills = storage.get('bills') || [];
                        item = bills.find(b => b.id === itemId);
                    }
                }

                switch(type) {
                    case 'income':
                        return `
                            <h3 class="text-xl font-bold mb-4">${isEdit ? 'Edit' : 'Add'} Income</h3>
                            <form data-form="${isEdit ? 'edit-income' : 'add-income'}">
                                ${isEdit ? `<input type="hidden" name="id" value="${item.id}">` : ''}
                                <div class="space-y-4">
                                    <input type="text" name="source" placeholder="Income Source" required
                                        value="${item?.source || ''}"
                                        class="form-input">
                                    <input type="number" name="amount" placeholder="Amount" step="0.01" required
                                        value="${item?.amount || ''}"
                                        class="form-input">
                                    <select name="frequency" class="form-input">
                                        <option value="monthly" ${item?.frequency === 'monthly' ? 'selected' : ''}>Monthly</option>
                                        <option value="bi-weekly" ${item?.frequency === 'bi-weekly' ? 'selected' : ''}>Bi-weekly</option>
                                        <option value="weekly" ${item?.frequency === 'weekly' ? 'selected' : ''}>Weekly</option>
                                        <option value="one-time" ${item?.frequency === 'one-time' ? 'selected' : ''}>One-time</option>
                                    </select>
                                    <select name="type" class="form-input">
                                        <option value="salary" ${item?.type === 'salary' ? 'selected' : ''}>Salary</option>
                                        <option value="freelance" ${item?.type === 'freelance' ? 'selected' : ''}>Freelance</option>
                                        <option value="investment" ${item?.type === 'investment' ? 'selected' : ''}>Investment</option>
                                        <option value="other" ${item?.type === 'other' ? 'selected' : ''}>Other</option>
                                    </select>
                                    <div class="grid grid-cols-2 gap-3">
                                        <button type="submit" class="btn btn-primary">
                                            ${isEdit ? 'Update' : 'Add'} Income
                                        </button>
                                        <button type="button" data-action="close-modal" class="btn btn-secondary">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </form>
                        `;
                    
                    case 'bill':
                        return `
                            <h3 class="text-xl font-bold mb-4">${isEdit ? 'Edit' : 'Add'} Bill</h3>
                            <form data-form="${isEdit ? 'edit-bill' : 'add-bill'}">
                                ${isEdit ? `<input type="hidden" name="id" value="${item.id}">` : ''}
                                <div class="space-y-4">
                                    <input type="text" name="name" placeholder="Bill Name" required
                                        value="${item?.name || ''}"
                                        class="form-input">
                                    <input type="number" name="amount" placeholder="Amount" step="0.01" required
                                        value="${item?.amount || ''}"
                                        class="form-input">
                                    <input type="date" name="dueDate" required
                                        value="${item?.dueDate || ''}"
                                        class="form-input">
                                    <select name="category" class="form-input">
                                        <option value="utilities" ${item?.category === 'utilities' ? 'selected' : ''}>Utilities</option>
                                        <option value="rent" ${item?.category === 'rent' ? 'selected' : ''}>Rent/Mortgage</option>
                                        <option value="insurance" ${item?.category === 'insurance' ? 'selected' : ''}>Insurance</option>
                                        <option value="subscription" ${item?.category === 'subscription' ? 'selected' : ''}>Subscription</option>
                                        <option value="loan" ${item?.category === 'loan' ? 'selected' : ''}>Loan</option>
                                        <option value="other" ${item?.category === 'other' ? 'selected' : ''}>Other</option>
                                    </select>
                                    <div class="flex items-center space-x-2">
                                        <input type="checkbox" id="split" name="isSplit" 
                                            ${item?.isSplit ? 'checked' : ''}
                                            onchange="toggleSplitOptions(this)">
                                        <label for="split" class="text-sm">Split this bill</label>
                                    </div>
                                    <div id="split-options" style="display:${item?.isSplit ? 'block' : 'none'};">
                                        <input type="text" name="splitWith" placeholder="Split with (name)"
                                            value="${item?.splitWith || ''}"
                                            class="form-input mb-2">
                                        <label class="text-sm text-gray-600">Your share: <span id="share-percent">${item?.userShare || 50}</span>%</label>
                                        <input type="range" name="userShare" min="0" max="100" 
                                            value="${item?.userShare || 50}"
                                            oninput="document.getElementById('share-percent').textContent = this.value"
                                            class="w-full">
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <button type="submit" class="btn btn-primary">
                                            ${isEdit ? 'Update' : 'Add'} Bill
                                        </button>
                                        <button type="button" data-action="close-modal" class="btn btn-secondary">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </form>
                        `;
                }
            }

            async calculateTotals() {
                const incomes = storage.get('incomes') || [];
                const bills = storage.get('bills') || [];
                
                const userIncomes = incomes.filter(i => i.userId === this.currentUser.id);
                const userBills = bills.filter(b => b.userId === this.currentUser.id);
                
                let monthlyIncome = 0;
                userIncomes.forEach(income => {
                    switch(income.frequency) {
                        case 'weekly': monthlyIncome += income.amount * 4.33; break;
                        case 'bi-weekly': monthlyIncome += income.amount * 2.17; break;
                        case 'monthly': monthlyIncome += income.amount; break;
                        case 'one-time': monthlyIncome += income.amount / 12; break;
                    }
                });
                
                let monthlyBills = 0;
                userBills.forEach(bill => {
                    const amount = bill.userShare ? (bill.amount * bill.userShare / 100) : bill.amount;
                    monthlyBills += amount;
                });
                
                return {
                    income: monthlyIncome,
                    bills: monthlyBills,
                    remaining: monthlyIncome - monthlyBills
                };
            }

            async render() {
                const app = document.getElementById('app');
                
                if (this.currentView === 'login') {
                    app.innerHTML = this.renderLogin();
                } else {
                    // Check session validity before rendering app
                    if (!security.isSessionValid()) {
                        this.handleSessionExpired();
                        return;
                    }
                    
                    const totals = await this.calculateTotals();
                    const incomes = storage.get('incomes') || [];
                    const bills = storage.get('bills') || [];
                    const notifications = storage.get('notifications') || [];
                    
                    const userIncomes = incomes.filter(i => i.userId === this.currentUser.id);
                    const userBills = bills.filter(b => b.userId === this.currentUser.id);
                    const unreadNotifications = notifications.filter(n => !n.read);
                    
                    app.innerHTML = this.renderApp(totals, userIncomes, userBills, unreadNotifications);
                }
            }

            renderLogin() {
                return `
                    <div class="min-h-screen gradient-bg flex items-center justify-center p-4">
                        <div class="glass rounded-2xl shadow-2xl w-full max-w-md p-8">
                            <div class="text-center mb-8">
                                <div class="bg-white bg-opacity-20 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                            d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <h1 class="text-3xl font-bold text-gray-800">Smart Budget</h1>
                                <p class="text-gray-600 mt-2">Your Financial Management Partner</p>
                                ${this.sessionExpiredMessage ? `
                                    <div class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm">
                                        <div class="flex items-center">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                            </svg>
                                            ${this.sessionExpiredMessage}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>

                            <div id="login-form">
                                <form data-form="login">
                                    <div class="space-y-4">
                                        <input type="email" name="email" placeholder="Email" required
                                            class="form-input">
                                        <input type="password" name="password" placeholder="Password" required
                                            class="form-input">
                                        <button type="submit" class="w-full btn btn-primary">
                                            Log In
                                        </button>
                                    </div>
                                </form>
                                <div class="text-center mt-4">
                                    <button data-action="switch-to-signup" class="text-purple-600 hover:underline btn">
                                        Don't have an account? Sign up
                                    </button>
                                </div>
                            </div>

                            <div id="signup-form" style="display:none;">
                                <form data-form="signup">
                                    <div class="space-y-4">
                                        <input type="text" name="name" placeholder="Full Name" required
                                            class="form-input">
                                        <input type="email" name="email" placeholder="Email" required
                                            class="form-input">
                                        <input type="password" name="password" placeholder="Password" required
                                            class="form-input">
                                        <button type="submit" class="w-full btn btn-primary">
                                            Create Account
                                        </button>
                                    </div>
                                </form>
                                <div class="text-center mt-4">
                                    <button data-action="switch-to-login" class="text-purple-600 hover:underline btn">
                                        Already have an account? Log in
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mt-6 text-center">
                                <div class="text-xs text-gray-500 bg-white bg-opacity-50 rounded-lg p-2">
                                    <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                            d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                                    </svg>
                                    Secure session timeout: 5 minutes
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderApp(totals, incomes, bills, notifications) {
                return `
                    <div class="min-h-screen bg-gray-50">
                        <!-- Header -->
                        <header class="gradient-bg text-white shadow-lg sticky top-0 z-40">
                            <div class="max-w-7xl mx-auto px-4 py-4">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center space-x-4">
                                        <div class="bg-white bg-opacity-20 p-2 rounded-lg">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                        </div>
                                        <div>
                                            <h1 class="text-xl font-bold">Smart Budget</h1>
                                            <p class="text-sm opacity-90">Welcome, ${this.currentUser.name}</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <button class="${notifications.length > 0 ? 'notification-dot relative' : ''} btn p-2">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                                            </svg>
                                        </button>
                                        <button data-action="toggle-private" class="btn p-2">
                                            ${this.privateMode ? 
                                                '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path></svg>' :
                                                '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>'
                                            }
                                        </button>
                                        <button data-action="logout" class="btn p-2">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </header>

                        <!-- Navigation Tabs -->
                        <div class="bg-white shadow-sm border-b sticky top-16 z-30">
                            <div class="max-w-7xl mx-auto">
                                <div class="flex space-x-4 px-4 tab-nav">
                                    ${['dashboard', 'income', 'bills', 'history'].map(tab => `
                                        <button data-action="switch-tab" data-tab="${tab}" 
                                            class="btn py-4 px-4 border-b-2 font-medium text-sm transition whitespace-nowrap ${
                                                this.activeTab === tab 
                                                    ? 'border-purple-600 text-purple-600' 
                                                    : 'border-transparent text-gray-500 hover:text-gray-700'
                                            }">
                                            ${tab.charAt(0).toUpperCase() + tab.slice(1)}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Main Content -->
                        <div class="max-w-7xl mx-auto p-4">
                            <!-- Notifications -->
                            ${notifications.length > 0 ? `
                                <div class="mb-4 space-y-2">
                                    ${notifications.map(n => `
                                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 flex justify-between items-center fade-in rounded-lg">
                                            <div class="flex items-center">
                                                <svg class="w-5 h-5 text-yellow-600 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                                </svg>
                                                <span class="text-sm">${n.message}</span>
                                            </div>
                                            <button data-action="dismiss-notification" data-notification-id="${n.id}" 
                                                class="btn p-2 text-yellow-600 hover:text-yellow-800">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                </svg>
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}

                            ${this.activeTab === 'dashboard' ? `
                                <!-- Dashboard Tab -->
                                <div class="space-y-6 fade-in">
                                    <!-- Summary Cards -->
                                    <div class="grid-responsive">
                                        <div class="card card-mobile">
                                            <div class="flex items-center justify-between mb-2">
                                                <h3 class="text-gray-600 text-sm font-medium">Monthly Income</h3>
                                                <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                                                </svg>
                                            </div>
                                            <p class="text-2xl font-bold ${this.privateMode ? 'filter blur-sm' : ''}">
                                                $${totals.income.toFixed(2)}
                                            </p>
                                        </div>
                                        
                                        <div class="card card-mobile">
                                            <div class="flex items-center justify-between mb-2">
                                                <h3 class="text-gray-600 text-sm font-medium">Monthly Bills</h3>
                                                <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                        d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                                                </svg>
                                            </div>
                                            <p class="text-2xl font-bold">
                                                $${totals.bills.toFixed(2)}
                                            </p>
                                        </div>
                                        
                                        <div class="card card-mobile">
                                            <div class="flex items-center justify-between mb-2">
                                                <h3 class="text-gray-600 text-sm font-medium">Remaining</h3>
                                                <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                        d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                                </svg>
                                            </div>
                                            <p class="text-2xl font-bold ${totals.remaining >= 0 ? 'text-green-600' : 'text-red-600'} ${this.privateMode ? 'filter blur-sm' : ''}">
                                                $${totals.remaining.toFixed(2)}
                                            </p>
                                        </div>
                                    </div>

                                    <!-- Credit Score -->
                                    <div class="card p-6">
                                        <h3 class="text-lg font-bold mb-4">Credit Score</h3>
                                        <div class="flex items-center space-x-6">
                                            <div class="text-center">
                                                <div class="text-4xl font-bold ${
                                                    this.currentUser.creditScore >= 750 ? 'text-green-600' : 
                                                    this.currentUser.creditScore >= 650 ? 'text-yellow-600' : 'text-red-600'
                                                }">
                                                    ${this.currentUser.creditScore}
                                                </div>
                                                <p class="text-sm text-gray-600 mt-1">
                                                    ${this.currentUser.creditScore >= 750 ? 'Excellent' : 
                                                     this.currentUser.creditScore >= 650 ? 'Good' : 'Fair'}
                                                </p>
                                            </div>
                                            <div class="flex-1">
                                                <div class="bg-gray-200 rounded-full h-4">
                                                    <div class="h-4 rounded-full transition-all duration-500 ${
                                                        this.currentUser.creditScore >= 750 ? 'bg-green-600' : 
                                                        this.currentUser.creditScore >= 650 ? 'bg-yellow-600' : 'bg-red-600'
                                                    }" style="width: ${((this.currentUser.creditScore - 300) / 550) * 100}%"></div>
                                                </div>
                                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                                    <span>300</span>
                                                    <span>850</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Quick Actions -->
                                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                        <button data-action="show-modal" data-modal="income" 
                                            class="card card-mobile hover:shadow-lg transition flex flex-col items-center space-y-2 btn">
                                            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                            </svg>
                                            <span class="text-sm font-medium">Add Income</span>
                                        </button>
                                        
                                        <button data-action="show-modal" data-modal="bill" 
                                            class="card card-mobile hover:shadow-lg transition flex flex-col items-center space-y-2 btn">
                                            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                            </svg>
                                            <span class="text-sm font-medium">Add Bill</span>
                                        </button>
                                        
                                        <button class="card card-mobile hover:shadow-lg transition flex flex-col items-center space-y-2 btn">
                                            <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                                            </svg>
                                            <span class="text-sm font-medium">Link Account</span>
                                        </button>
                                        
                                        <button class="card card-mobile hover:shadow-lg transition flex flex-col items-center space-y-2 btn">
                                            <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                                            </svg>
                                            <span class="text-sm font-medium">Card Offers</span>
                                        </button>
                                    </div>
                                </div>
                            ` : ''}

                            ${this.activeTab === 'income' ? `
                                <!-- Income Tab -->
                                <div class="card fade-in">
                                    <div class="p-6 border-b flex justify-between items-center">
                                        <h2 class="text-xl font-bold">Income Sources</h2>
                                        <button data-action="show-modal" data-modal="income" 
                                            class="btn btn-primary">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                            </svg>
                                            <span>Add Income</span>
                                        </button>
                                    </div>
                                    <div class="p-6">
                                        ${incomes.length === 0 ? `
                                            <div class="text-center py-12">
                                                <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                <p class="text-gray-500">No income sources added yet</p>
                                                <p class="text-sm text-gray-400 mt-2">Add your income sources to start tracking</p>
                                            </div>
                                        ` : `
                                            <div class="space-y-3">
                                                ${incomes.map(income => `
                                                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                                        <div class="flex items-center space-x-4">
                                                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                                </svg>
                                                            </div>
                                                            <div class="flex-1">
                                                                <p class="font-medium">${income.source}</p>
                                                                <p class="text-sm text-gray-600">
                                                                    ${income.type}  ${income.frequency}
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <div class="flex items-center space-x-2">
                                                            <p class="text-lg font-bold text-green-600 ${this.privateMode ? 'filter blur-sm' : ''}">
                                                                $${income.amount.toFixed(2)}
                                                            </p>
                                                            <div class="flex space-x-1">
                                                                <button data-action="show-modal" data-modal="income" data-id="${income.id}" 
                                                                    class="btn p-2 text-blue-600 hover:text-blue-800">
                                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                                    </svg>
                                                                </button>
                                                                <button data-action="delete-income" data-income-id="${income.id}" 
                                                                    class="btn p-2 text-red-600 hover:text-red-800">
                                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                                    </svg>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        `}
                                    </div>
                                </div>
                            ` : ''}

                            ${this.activeTab === 'bills' ? `
                                <!-- Bills Tab -->
                                <div class="card fade-in">
                                    <div class="p-6 border-b flex justify-between items-center">
                                        <h2 class="text-xl font-bold">Bills & Payments</h2>
                                        <button data-action="show-modal" data-modal="bill" 
                                            class="btn btn-primary">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                            </svg>
                                            <span>Add Bill</span>
                                        </button>
                                    </div>
                                    <div class="p-6">
                                        ${bills.length === 0 ? `
                                            <div class="text-center py-12">
                                                <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                                </svg>
                                                <p class="text-gray-500">No bills added yet</p>
                                                <p class="text-sm text-gray-400 mt-2">Add your bills to track due dates and payments</p>
                                            </div>
                                        ` : `
                                            <div class="space-y-3">
                                                ${bills.map(bill => `
                                                    <div class="p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                                        <div class="flex items-center justify-between mb-3">
                                                            <div class="flex items-center space-x-4 flex-1">
                                                                <div class="w-10 h-10 ${bill.paid ? 'bg-green-100' : 'bg-red-100'} rounded-full flex items-center justify-center">
                                                                    <svg class="w-6 h-6 ${bill.paid ? 'text-green-600' : 'text-red-600'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        ${bill.paid ? 
                                                                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />' :
                                                                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />'
                                                                        }
                                                                    </svg>
                                                                </div>
                                                                <div class="flex-1">
                                                                    <p class="font-medium">${bill.name}</p>
                                                                    <p class="text-sm text-gray-600">
                                                                        Due: ${new Date(bill.dueDate).toLocaleDateString()}  ${bill.category}
                                                                    </p>
                                                                    ${bill.isSplit ? `
                                                                        <p class="text-sm text-purple-600 flex items-center mt-1">
                                                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                                                                            </svg>
                                                                            Split with ${bill.splitWith} (You: ${bill.userShare}%)
                                                                        </p>
                                                                    ` : ''}
                                                                </div>
                                                            </div>
                                                            <div class="flex items-center space-x-3">
                                                                <div class="text-right">
                                                                    <p class="text-lg font-bold">
                                                                        $${bill.userShare ? (bill.amount * bill.userShare / 100).toFixed(2) : bill.amount.toFixed(2)}
                                                                    </p>
                                                                    ${bill.isSplit ? `
                                                                        <p class="text-xs text-gray-500">Total: $${bill.amount.toFixed(2)}</p>
                                                                    ` : ''}
                                                                </div>
                                                                <div class="flex space-x-1">
                                                                    <button data-action="show-modal" data-modal="bill" data-id="${bill.id}" 
                                                                        class="btn p-2 text-blue-600 hover:text-blue-800">
                                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                                        </svg>
                                                                    </button>
                                                                    <button data-action="delete-bill" data-bill-id="${bill.id}" 
                                                                        class="btn p-2 text-red-600 hover:text-red-800">
                                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                                        </svg>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        ${!bill.paid ? `
                                                            <button data-action="mark-paid" data-bill-id="${bill.id}" 
                                                                class="w-full mt-3 btn btn-success">
                                                                Mark as Paid
                                                            </button>
                                                        ` : `
                                                            <div class="mt-3 text-center text-green-600 font-medium">
                                                                 Paid on ${new Date(bill.paidDate).toLocaleDateString()}
                                                            </div>
                                                        `}
                                                    </div>
                                                `).join('')}
                                            </div>
                                        `}
                                    </div>
                                </div>
                            ` : ''}

                            ${this.activeTab === 'history' ? `
                                <!-- History Tab -->
                                <div class="card fade-in">
                                    <div class="p-6 border-b">
                                        <h2 class="text-xl font-bold">Transaction History</h2>
                                    </div>
                                    <div class="p-6">
                                        <div class="text-center py-12">
                                            <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            <p class="text-gray-500">Transaction history coming soon</p>
                                            <p class="text-sm text-gray-400 mt-2">Your payment history will appear here</p>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
        }

        // Helper function for split bill toggle
        function toggleSplitOptions(checkbox) {
            const splitOptions = document.getElementById('split-options');
            splitOptions.style.display = checkbox.checked ? 'block' : 'none';
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript,' + encodeURIComponent(`
                const CACHE_NAME = 'smartbudget-secure-v1';
                const urlsToCache = [
                    '/',
                    'https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css'
                ];

                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => {
                                console.log('Opened cache');
                                return cache.addAll(urlsToCache);
                            })
                    );
                    self.skipWaiting();
                });

                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request)
                            .then(response => {
                                if (response) {
                                    return response;
                                }
                                return fetch(event.request)
                                    .then(response => {
                                        if (!response || response.status !== 200 || response.type !== 'basic') {
                                            return response;
                                        }
                                        
                                        const responseToCache = response.clone();
                                        caches.open(CACHE_NAME)
                                            .then(cache => {
                                                cache.put(event.request, responseToCache);
                                            });
                                        
                                        return response;
                                    })
                                    .catch(() => {
                                        return caches.match('/');
                                    });
                            })
                    );
                });

                self.addEventListener('activate', event => {
                    event.waitUntil(
                        caches.keys().then(cacheNames => {
                            return Promise.all(
                                cacheNames.map(cacheName => {
                                    if (cacheName !== CACHE_NAME) {
                                        return caches.delete(cacheName);
                                    }
                                })
                            );
                        })
                    );
                    event.waitUntil(clients.claim());
                });

                self.addEventListener('push', event => {
                    const options = {
                        body: event.data ? event.data.text() : 'You have a bill reminder!',
                        icon: '/icon-192x192.png',
                        badge: '/icon-192x192.png',
                        vibrate: [200, 100, 200],
                        data: {
                            dateOfArrival: Date.now(),
                            primaryKey: 1
                        },
                        actions: [
                            {
                                action: 'view',
                                title: 'View Bill',
                                icon: '/icon-192x192.png'
                            },
                            {
                                action: 'close',
                                title: 'Close'
                            }
                        ]
                    };

                    event.waitUntil(
                        self.registration.showNotification('Smart Budget', options)
                    );
                });

                self.addEventListener('notificationclick', event => {
                    event.notification.close();

                    if (event.action === 'view') {
                        event.waitUntil(
                            clients.openWindow('/')
                        );
                    }
                });
            `)).then(registration => {
                console.log('ServiceWorker registration successful');
            }).catch(err => {
                console.log('ServiceWorker registration failed: ', err);
            });
        }

        // Initialize app
        const app = new SmartBudgetApp();
    </script>
</body>
</html>
