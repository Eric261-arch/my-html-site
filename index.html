<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Budget - Financial Management App</title>
    <meta name="description" content="Manage your finances, split bills, and track expenses with Smart Budget">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            touch-action: manipulation;
        }
        
        .gradient-bg { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        }
        
        .glass { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .fade-in { 
            animation: fadeIn 0.3s ease-in; 
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .notification-dot::after { 
            content: ''; 
            position: absolute; 
            top: -2px; 
            right: -2px; 
            width: 8px; 
            height: 8px; 
            background: #ef4444; 
            border-radius: 50%; 
        }

        .btn {
            min-height: 44px;
            min-width: 44px;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            border: none;
        }

        .btn-success {
            background: #10b981;
            color: white;
            border: none;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
            border: none;
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            overflow: hidden;
        }

        .card-mobile {
            margin-bottom: 16px;
            padding: 16px;
        }

        .grid-responsive {
            display: grid;
            gap: 16px;
            grid-template-columns: 1fr;
        }

        @media (min-width: 640px) {
            .grid-responsive {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .grid-responsive {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .form-input {
            width: 100%;
            min-height: 44px;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #f59e0b;
            color: white;
            text-align: center;
            padding: 8px;
            z-index: 9999;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .offline-banner.show {
            transform: translateY(0);
        }

        .error-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #dc2626;
            color: white;
            text-align: center;
            padding: 12px;
            z-index: 9999;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .error-banner.show {
            transform: translateY(0);
        }

        .shared-indicator {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .personal-indicator {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .connection-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .connection-active {
            background: #dcfce7;
            color: #15803d;
        }

        .connection-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>
    <div id="offline-banner" class="offline-banner">
        <span>You're offline. Changes will sync when connection is restored.</span>
    </div>
    
    <div id="error-banner" class="error-banner">
        <span id="error-message"></span>
    </div>
    
    <div id="app"></div>

    <!-- Load Supabase first -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://apkbziwtkbzzmjytlzsk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwa2J6aXd0a2J6em1qeXRsenNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MDg1NjksImV4cCI6MjA3MzM4NDU2OX0.Igr6QQ6ZiflS8tisPTrbjH3EW8e7Bw1PAP-RB72vdVM';
        
        // Initialize Supabase client - should be available immediately since we load the script first
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Enhanced Supabase Service
        class SupabaseService {
            constructor() {
                this.isOnline = navigator.onLine;
                this.syncQueue = [];
                this.setupOfflineHandling();
                this.subscriptions = [];
            }

            setupOfflineHandling() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.showOfflineBanner(false);
                    this.processSyncQueue();
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.showOfflineBanner(true);
                });
            }

            showOfflineBanner(show) {
                const banner = document.getElementById('offline-banner');
                banner.classList.toggle('show', show);
            }

            showErrorBanner(message, duration = 5000) {
                const banner = document.getElementById('error-banner');
                const messageEl = document.getElementById('error-message');
                messageEl.textContent = message;
                banner.classList.add('show');
                
                setTimeout(() => {
                    banner.classList.remove('show');
                }, duration);
            }

            async handleError(error, context = '') {
                console.error(`Supabase error ${context}:`, error);
                
                if (!this.isOnline) {
                    this.showErrorBanner('You are offline. Please check your connection.');
                    return null;
                }
                
                if (error.message?.includes('JWT')) {
                    this.showErrorBanner('Session expired. Please sign in again.');
                    if (window.app) {
                        window.app.handleSessionExpired();
                    }
                    return null;
                }
                
                this.showErrorBanner(`Error: ${error.message || 'Something went wrong'}`);
                return null;
            }

            async addToSyncQueue(operation) {
                this.syncQueue.push({
                    id: Date.now().toString(),
                    operation,
                    timestamp: new Date().toISOString()
                });
            }

            async processSyncQueue() {
                if (!this.isOnline || this.syncQueue.length === 0) return;
                
                console.log('Processing sync queue...');
                this.syncQueue = [];
            }

            // Authentication methods
            async signUp(email, password, name) {
                try {
                    const { data, error } = await supabaseClient.auth.signUp({
                        email,
                        password,
                        options: {
                            data: {
                                name: name
                            }
                        }
                    });

                    if (error) throw error;

                    // Create user profile
                    if (data.user) {
                        await this.createUserProfile(data.user.id, {
                            email,
                            name,
                            credit_score: Math.floor(Math.random() * 200) + 600
                        });
                    }

                    return { user: data.user, error: null };
                } catch (error) {
                    return { user: null, error: await this.handleError(error, 'signup') };
                }
            }

            async signIn(email, password) {
                try {
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email,
                        password
                    });

                    if (error) throw error;

                    return { user: data.user, error: null };
                } catch (error) {
                    return { user: null, error: await this.handleError(error, 'signin') };
                }
            }

            async signOut() {
                try {
                    const { error } = await supabaseClient.auth.signOut();
                    if (error) throw error;
                    
                    // Clean up subscriptions
                    this.subscriptions.forEach(sub => sub.unsubscribe());
                    this.subscriptions = [];
                    
                    return { error: null };
                } catch (error) {
                    return { error: await this.handleError(error, 'signout') };
                }
            }

            async getCurrentUser() {
                try {
                    const { data: { user }, error } = await supabaseClient.auth.getUser();
                    if (error) throw error;
                    return user;
                } catch (error) {
                    await this.handleError(error, 'getCurrentUser');
                    return null;
                }
            }

            async createUserProfile(userId, profileData) {
                try {
                    const { data, error } = await supabaseClient
                        .from('users')
                        .insert([{
                            id: userId,
                            ...profileData,
                            created_at: new Date().toISOString()
                        }])
                        .select()
                        .single();

                    if (error) throw error;
                    return data;
                } catch (error) {
                    return await this.handleError(error, 'createUserProfile');
                }
            }

            async getUserProfile(userId) {
                try {
                    const { data, error } = await supabaseClient
                        .from('users')
                        .select('*')
                        .eq('id', userId)
                        .single();

                    if (error) throw error;
                    return data;
                } catch (error) {
                    return await this.handleError(error, 'getUserProfile');
                }
            }

            // Income methods
            async addIncome(incomeData) {
                try {
                    const user = await this.getCurrentUser();
                    if (!user) throw new Error('User not authenticated');

                    const { data, error } = await supabaseClient
                        .from('incomes')
                        .insert([{
                            ...incomeData,
                            user_id: user.id,
                            created_at: new Date().toISOString()
                        }])
                        .select()
                        .single();

                    if (error) throw error;
                    return data;
                } catch (error) {
                    return await this.handleError(error, 'addIncome');
                }
            }

            async getUserIncomes() {
                try {
                    const user = await this.getCurrentUser();
                    if (!user) throw new Error('User not authenticated');

                    const { data, error } = await supabaseClient
                        .from('incomes')
                        .select('*')
                        .eq('user_id', user.id)
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    return data || [];
                } catch (error) {
                    return await this.handleError(error, 'getUserIncomes') || [];
                }
            }

            async updateIncome(incomeId, updates) {
                try {
                    const { data, error } = await supabaseClient
                        .from('incomes')
                        .update({
                            ...updates,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', incomeId)
                        .select()
                        .single();

                    if (error) throw error;
                    return data;
                } catch (error) {
                    return await this.handleError(error, 'updateIncome');
                }
            }

            async deleteIncome(incomeId) {
                try {
                    const { error } = await supabaseClient
                        .from('incomes')
                        .delete()
                        .eq('id', incomeId);

                    if (error) throw error;
                    return true;
                } catch (error) {
                    await this.handleError(error, 'deleteIncome');
                    return false;
                }
            }

            // Bill methods
            async addBill(billData) {
                try {
                    const user = await this.getCurrentUser();
                    if (!user) throw new Error('User not authenticated');

                    const { data, error } = await supabaseClient
                        .from('bills')
                        .insert([{
                            ...billData,
                            user_id: user.id,
                            created_at: new Date().toISOString(),
                            paid: false
                        }])
                        .select()
                        .single();

                    if (error) throw error;

                    // If bill is shared, create bill shares
                    if (billData.sharedWith && billData.sharedWith.length > 0) {
                        await this.createBillShares(data.id, billData.splits || {});
                    }

                    await this.scheduleNotification(data);
                    return data;
                } catch (error) {
                    return await this.handleError(error, 'addBill');
                }
            }

            async createBillShares(billId, splits) {
                try {
                    const shares = Object.entries(splits).map(([userId, amount]) => ({
                        bill_id: billId,
                        user_id: userId,
                        amount: amount,
                        created_at: new Date().toISOString()
                    }));

                    const { error } = await supabaseClient
                        .from('bill_shares')
                        .insert(shares);

                    if (error) throw error;
                    return true;
                } catch (error) {
                    await this.handleError(error, 'createBillShares');
                    return false;
                }
            }

            async getUserBills() {
                try {
                    const user = await this.getCurrentUser();
                    if (!user) throw new Error('User not authenticated');

                    // Get bills owned by user
                    const { data: ownedBills, error: ownedError } = await supabaseClient
                        .from('bills')
                        .select(`
                            *,
                            bill_shares (
                                user_id,
                                amount,
                                users (name, email)
                            )
                        `)
                        .eq('user_id', user.id)
                        .order('created_at', { ascending: false });

                    if (ownedError) throw ownedError;

                    // Get bills shared with user
                    const { data: sharedBills, error: sharedError } = await supabaseClient
                        .from('bill_shares')
                        .select(`
                            bills (
                                *,
                                users (name, email),
                                bill_shares (
                                    user_id,
                                    amount,
                                    users (name, email)
                                )
                            ),
                            amount
                        `)
                        .eq('user_id', user.id);

                    if (sharedError) throw sharedError;

                    // Combine and format bills
                    const allBills = [
                        ...(ownedBills || []),
                        ...(sharedBills || []).map(share => ({
                            ...share.bills,
                            user_share_amount: share.amount,
                            is_shared_with_me: true
                        }))
                    ];

                    return allBills;
                } catch (error) {
                    return await this.handleError(error, 'getUserBills') || [];
                }
            }

            async updateBill(billId, updates) {
                try {
                    const { data, error } = await supabaseClient
                        .from('bills')
                        .update({
                            ...updates,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', billId)
                        .select()
                        .single();

                    if (error) throw error;

                    if (updates.due_date) {
                        await this.scheduleNotification(data);
                    }

                    return data;
                } catch (error) {
                    return await this.handleError(error, 'updateBill');
                }
            }

            async deleteBill(billId) {
                try {
                    // Delete bill shares first
                    await supabaseClient
                        .from('bill_shares')
                        .delete()
                        .eq('bill_id', billId);

                    // Delete bill
                    const { error } = await supabaseClient
                        .from('bills')
                        .delete()
                        .eq('id', billId);

                    if (error) throw error;
                    return true;
                } catch (error) {
                    await this.handleError(error, 'deleteBill');
                    return false;
                }
            }

            // Connection methods
            async generateInviteCode() {
                return Math.random().toString(36).substring(2, 10).toUpperCase();
            }

            async createInvitation(inviteCode) {
                try {
                    const user = await this.getCurrentUser();
                    if (!user) throw new Error('User not authenticated');

                    const { data, error } = await supabaseClient
                        .from('invitations')
                        .insert([{
                            code: inviteCode,
                            from_user_id: user.id,
                            expires_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                            used: false,
                            created_at: new Date().toISOString()
                        }])
                        .select()
                        .single();

                    if (error) throw error;
                    return data;
                } catch (error) {
                    return await this.handleError(error, 'createInvitation');
                }
            }

            async findInvitation(code) {
                try {
                    const { data, error } = await supabaseClient
                        .from('invitations')
                        .select('*, users!invitations_from_user_id_fkey(name, email)')
                        .eq('code', code.toUpperCase())
                        .eq('used', false)
                        .gt('expires_at', new Date().toISOString())
                        .single();

                    if (error) throw error;
                    return data;
                } catch (error) {
                    return await this.handleError(error, 'findInvitation');
                }
            }

            async acceptInvitation(invitation) {
                try {
                    const user = await this.getCurrentUser();
                    if (!user) throw new Error('User not authenticated');

                    // Check if already connected
                    const existingConnection = await this.checkConnection(user.id, invitation.from_user_id);
                    if (existingConnection) {
                        throw new Error('Already connected to this user');
                    }

                    // Mark invitation as used
                    await supabaseClient
                        .from('invitations')
                        .update({
                            used: true,
                            to_user_id: user.id,
                            used_at: new Date().toISOString()
                        })
                        .eq('id', invitation.id);

                    // Create bidirectional connection
                    await this.createConnection(invitation.from_user_id, user.id);
                    await this.createConnection(user.id, invitation.from_user_id);

                    return true;
                } catch (error) {
                    await this.handleError(error, 'acceptInvitation');
                    return false;
                }
            }

            async createConnection(fromUserId, toUserId) {
                try {
                    const { data, error } = await supabaseClient
                        .from('connections')
                        .insert([{
                            from_user_id: fromUserId,
                            to_user_id: toUserId,
                            created_at: new Date().toISOString()
                        }])
                        .select()
                        .single();

                    if (error) throw error;
                    return data;
                } catch (error) {
                    return await this.handleError(error, 'createConnection');
                }
            }

            async checkConnection(userId1, userId2) {
                try {
                    const { data, error } = await supabaseClient
                        .from('connections')
                        .select('*')
                        .eq('from_user_id', userId1)
                        .eq('to_user_id', userId2)
                        .single();

                    if (error && error.code !== 'PGRST116') throw error;
                    return data;
                } catch (error) {
                    return await this.handleError(error, 'checkConnection');
                }
            }

            async getUserConnections() {
                try {
                    const user = await this.getCurrentUser();
                    if (!user) throw new Error('User not authenticated');

                    const { data, error } = await supabaseClient
                        .from('connections')
                        .select(`
                            to_user_id,
                            users!connections_to_user_id_fkey (
                                id,
                                name,
                                email
                            )
                        `)
                        .eq('from_user_id', user.id);

                    if (error) throw error;
                    return (data || []).map(conn => conn.users);
                } catch (error) {
                    return await this.handleError(error, 'getUserConnections') || [];
                }
            }

            async removeConnection(connectedUserId) {
                try {
                    const user = await this.getCurrentUser();
                    if (!user) throw new Error('User not authenticated');

                    // Remove bidirectional connections
                    await supabaseClient
                        .from('connections')
                        .delete()
                        .eq('from_user_id', user.id)
                        .eq('to_user_id', connectedUserId);

                    await supabaseClient
                        .from('connections')
                        .delete()
                        .eq('from_user_id', connectedUserId)
                        .eq('to_user_id', user.id);

                    return true;
                } catch (error) {
                    await this.handleError(error, 'removeConnection');
                    return false;
                }
            }

            // Notification methods
            async getUserNotifications() {
                try {
                    const user = await this.getCurrentUser();
                    if (!user) throw new Error('User not authenticated');

                    const { data, error } = await supabaseClient
                        .from('notifications')
                        .select('*')
                        .eq('user_id', user.id)
                        .eq('read', false)
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    return data || [];
                } catch (error) {
                    return await this.handleError(error, 'getUserNotifications') || [];
                }
            }

            async dismissNotification(notificationId) {
                try {
                    const { error } = await supabaseClient
                        .from('notifications')
                        .update({ read: true })
                        .eq('id', notificationId);

                    if (error) throw error;
                    return true;
                } catch (error) {
                    await this.handleError(error, 'dismissNotification');
                    return false;
                }
            }

            async checkUpcomingBills() {
                try {
                    const user = await this.getCurrentUser();
                    if (!user) throw new Error('User not authenticated');

                    const bills = await this.getUserBills();
                    const today = new Date();

                    for (const bill of bills) {
                        if (!bill.paid) {
                            const dueDate = new Date(bill.due_date);
                            const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

                            if (daysUntil <= 3 && daysUntil >= 0) {
                                await this.createNotification(
                                    user.id,
                                    'bill_reminder',
                                    `${bill.name} due in ${daysUntil} days`,
                                    { bill_id: bill.id }
                                );
                            }
                        }
                    }
                } catch (error) {
                    await this.handleError(error, 'checkUpcomingBills');
                }
            }

            async createNotification(userId, type, message, metadata = {}) {
                try {
                    // Check if notification already exists
                    const { data: existing } = await supabaseClient
                        .from('notifications')
                        .select('id')
                        .eq('user_id', userId)
                        .eq('type', type)
                        .eq('metadata->bill_id', metadata.bill_id)
                        .eq('read', false);

                    if (existing && existing.length > 0) return;

                    const { data, error } = await supabaseClient
                        .from('notifications')
                        .insert([{
                            user_id: userId,
                            type,
                            message,
                            metadata,
                            read: false,
                            created_at: new Date().toISOString()
                        }])
                        .select()
                        .single();

                    if (error) throw error;
                    return data;
                } catch (error) {
                    return await this.handleError(error, 'createNotification');
                }
            }

            async scheduleNotification(bill) {
                if (!('Notification' in window)) return;

                const permission = await Notification.requestPermission();
                if (permission !== 'granted') return;

                const dueDate = new Date(bill.due_date);
                const today = new Date();
                const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

                if (daysUntil === 1) {
                    setTimeout(() => {
                        new Notification('Bill Reminder', {
                            body: `${bill.name} is due tomorrow ($${bill.amount})`,
                            icon: '/icon-192x192.png',
                            badge: '/icon-192x192.png',
                            tag: `bill-${bill.id}`,
                            requireInteraction: true
                        });
                    }, 1000);
                }
            }

            // Real-time subscriptions
            subscribeToUserData(userId, callback) {
                const subscription = supabaseClient
                    .channel('user-data')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'bills', filter: `user_id=eq.${userId}` },
                        callback
                    )
                    .on('postgres_changes',
                        { event: '*', schema: 'public', table: 'incomes', filter: `user_id=eq.${userId}` },
                        callback
                    )
                    .on('postgres_changes',
                        { event: '*', schema: 'public', table: 'notifications', filter: `user_id=eq.${userId}` },
                        callback
                    )
                    .subscribe();

                this.subscriptions.push(subscription);
                return subscription;
            }
        }

        // Enhanced Main App Class
        class SmartBudgetApp {
            constructor() {
                this.currentUser = null;
                this.currentView = 'login';
                this.activeTab = 'dashboard';
                this.privateMode = false;
                this.loading = false;
                this.dataLoading = false;
                this.init();
            }

            async init() {
                // Check for existing session
                const user = await storage.getCurrentUser();
                if (user) {
                    this.currentUser = await storage.getUserProfile(user.id);
                    if (this.currentUser) {
                        this.currentView = 'app';
                        this.setupRealtimeSubscription();
                    }
                }

                await this.requestNotificationPermission();
                this.render();
                this.attachEventListeners();

                // Check for notifications periodically
                setInterval(() => {
                    if (this.currentUser) {
                        storage.checkUpcomingBills();
                    }
                }, 60000);

                window.app = this;
            }

            setupRealtimeSubscription() {
                if (this.currentUser) {
                    storage.subscribeToUserData(this.currentUser.id, (payload) => {
                        console.log('Real-time update:', payload);
                        this.render(); // Re-render on data changes
                    });
                }
            }

            async requestNotificationPermission() {
                if ('Notification' in window && 'serviceWorker' in navigator) {
                    const permission = await Notification.requestPermission();
                    console.log('Notification permission:', permission);
                }
            }

            handleSessionExpired() {
                this.currentUser = null;
                this.currentView = 'login';
                this.render();
            }

            attachEventListeners() {
                document.addEventListener('click', (e) => {
                    if (e.target.matches('[data-action]') || e.target.closest('[data-action]')) {
                        const element = e.target.matches('[data-action]') ? e.target : e.target.closest('[data-action]');
                        const action = element.dataset.action;
                        this.handleAction(action, element);
                    }
                });

                document.addEventListener('submit', (e) => {
                    if (e.target.matches('[data-form]')) {
                        e.preventDefault();
                        const formType = e.target.dataset.form;
                        this.handleFormSubmit(formType, new FormData(e.target));
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeModal();
                    }
                });
            }

            setLoading(isLoading) {
                this.loading = isLoading;
                const app = document.getElementById('app');
                app.classList.toggle('loading', isLoading);
            }

            setDataLoading(isLoading) {
                this.dataLoading = isLoading;
            }

            async handleAction(action, element) {
                if (element.disabled) return;

                element.disabled = true;
                this.setLoading(true);

                try {
                    switch (action) {
                        case 'logout':
                            await storage.signOut();
                            this.currentUser = null;
                            this.currentView = 'login';
                            this.render();
                            break;

                        case 'toggle-private':
                            this.privateMode = !this.privateMode;
                            this.render();
                            break;

                        case 'switch-tab':
                            this.activeTab = element.dataset.tab;
                            this.render();
                            break;

                        case 'show-modal':
                            this.showModal(element.dataset.modal, element.dataset.id);
                            break;

                        case 'close-modal':
                            this.closeModal();
                            break;

                        case 'mark-paid':
                            await this.markBillPaid(element.dataset.billId);
                            break;

                        case 'dismiss-notification':
                            await this.dismissNotification(element.dataset.notificationId);
                            break;

                        case 'delete-income':
                            await this.deleteIncome(element.dataset.incomeId);
                            break;

                        case 'delete-bill':
                            await this.deleteBill(element.dataset.billId);
                            break;

                        case 'remove-connection':
                            await this.removeConnection(element.dataset.connectionId);
                            break;

                        case 'switch-to-signup':
                            document.getElementById('login-form').style.display = 'none';
                            document.getElementById('signup-form').style.display = 'block';
                            break;

                        case 'switch-to-login':
                            document.getElementById('signup-form').style.display = 'none';
                            document.getElementById('login-form').style.display = 'block';
                            break;
                    }
                } finally {
                    element.disabled = false;
                    this.setLoading(false);
                }
            }

            async handleFormSubmit(formType, formData) {
                this.setLoading(true);
                const data = Object.fromEntries(formData);

                try {
                    switch (formType) {
                        case 'login':
                            const loginResult = await storage.signIn(data.email, data.password);
                            if (loginResult.user) {
                                this.currentUser = await storage.getUserProfile(loginResult.user.id);
                                this.currentView = 'app';
                                this.setupRealtimeSubscription();
                                this.render();
                            } else {
                                this.showError('Invalid credentials. Please try again.');
                            }
                            break;

                        case 'signup':
                            const signupResult = await storage.signUp(data.email, data.password, data.name);
                            if (signupResult.user) {
                                this.currentUser = await storage.getUserProfile(signupResult.user.id);
                                this.currentView = 'app';
                                this.setupRealtimeSubscription();
                                this.render();
                            } else {
                                this.showError('Failed to create account. Please try again.');
                            }
                            break;

                        case 'generate-invite':
                            await this.generateInvite();
                            break;

                        case 'accept-invite':
                            await this.acceptInvite(data.inviteCode);
                            break;

                        case 'add-income':
                        case 'edit-income':
                            const incomeData = {
                                source: data.source,
                                amount: parseFloat(data.amount),
                                frequency: data.frequency,
                                type: data.type
                            };

                            if (formType === 'edit-income' && data.id) {
                                await storage.updateIncome(data.id, incomeData);
                            } else {
                                await storage.addIncome(incomeData);
                            }
                            this.closeModal();
                            this.render();
                            break;

                        case 'add-bill':
                        case 'edit-bill':
                            const billData = {
                                name: data.name,
                                amount: parseFloat(data.amount),
                                due_date: data.dueDate,
                                category: data.category
                            };

                            // Handle shared bills
                            if (data.shareWith && data.shareWith !== '') {
                                const userConnections = await storage.getUserConnections();
                                const sharedUser = userConnections.find(c => c.id === data.shareWith);

                                if (sharedUser) {
                                    billData.sharedWith = [data.shareWith];
                                    billData.splits = {};

                                    if (data.splitType === 'equal') {
                                        billData.splits[this.currentUser.id] = billData.amount / 2;
                                        billData.splits[data.shareWith] = billData.amount / 2;
                                    } else if (data.splitType === 'custom') {
                                        const userAmount = parseFloat(data.userAmount) || 0;
                                        billData.splits[this.currentUser.id] = userAmount;
                                        billData.splits[data.shareWith] = billData.amount - userAmount;
                                    }
                                }
                            }

                            if (formType === 'edit-bill' && data.id) {
                                await storage.updateBill(data.id, billData);
                            } else {
                                await storage.addBill(billData);
                            }
                            this.closeModal();
                            this.render();
                            break;
                    }
                } catch (error) {
                    this.showError('An error occurred. Please try again.');
                    console.error(error);
                } finally {
                    this.setLoading(false);
                }
            }

            async generateInvite() {
                const inviteCode = await storage.generateInviteCode();
                const invitation = await storage.createInvitation(inviteCode);

                if (invitation) {
                    try {
                        await navigator.clipboard.writeText(inviteCode);
                        this.showSuccess(`Invite code ${inviteCode} copied to clipboard! Valid for 7 days.`);
                    } catch (err) {
                        this.showSuccess(`Invite code: ${inviteCode} (Valid for 7 days)`);
                    }
                }

                this.closeModal();
                this.render();
            }

            async acceptInvite(inviteCode) {
                const invitation = await storage.findInvitation(inviteCode.toUpperCase());

                if (!invitation) {
                    this.showError('Invalid or expired invite code.');
                    return;
                }

                const success = await storage.acceptInvitation(invitation);
                if (success) {
                    this.showSuccess(`Connected with ${invitation.users?.name || 'user'}!`);
                    this.closeModal();
                    this.render();
                } else {
                    this.showError('Failed to accept invitation. Please try again.');
                }
            }

            async removeConnection(connectionId) {
                const connections = await storage.getUserConnections();
                const connection = connections.find(c => c.id === connectionId);

                if (confirm(`Remove connection with ${connection?.name}? This will also remove any shared bills.`)) {
                    const success = await storage.removeConnection(connectionId);
                    if (success) {
                        this.render();
                    }
                }
            }

            showError(message) {
                const toast = document.createElement('div');
                toast.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in';
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }

            showSuccess(message) {
                const toast = document.createElement('div');
                toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in';
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 4000);
            }

            async markBillPaid(billId) {
                const success = await storage.updateBill(billId, {
                    paid: true,
                    paid_date: new Date().toISOString()
                });
                if (success) {
                    this.render();
                }
            }

            async dismissNotification(notificationId) {
                const success = await storage.dismissNotification(notificationId);
                if (success) {
                    this.render();
                }
            }

            async deleteIncome(incomeId) {
                if (confirm('Are you sure you want to delete this income source?')) {
                    const success = await storage.deleteIncome(incomeId);
                    if (success) {
                        this.render();
                    }
                }
            }

            async deleteBill(billId) {
                if (confirm('Are you sure you want to delete this bill?')) {
                    const success = await storage.deleteBill(billId);
                    if (success) {
                        this.render();
                    }
                }
            }

            showModal(modalType, itemId = null) {
                const modalContent = this.getModalContent(modalType, itemId);
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 fade-in';
                modal.innerHTML = `
                    <div class="glass rounded-2xl p-6 w-full max-w-md max-h-screen overflow-y-auto">
                        ${modalContent}
                    </div>
                `;
                document.body.appendChild(modal);

                setTimeout(() => {
                    const firstInput = modal.querySelector('input, select, textarea');
                    if (firstInput) firstInput.focus();
                }, 100);
            }

            closeModal() {
                const modal = document.querySelector('.fixed.inset-0');
                if (modal) modal.remove();
            }

            getModalContent(type, itemId) {
                switch (type) {
                    case 'connections':
                        return `
                            <h3 class="text-xl font-bold mb-4">Manage Connections</h3>
                            
                            <!-- Generate Invite -->
                            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                                <h4 class="font-medium mb-2">Invite Someone</h4>
                                <p class="text-sm text-gray-600 mb-3">Generate an invite code to share bills with family or roommates.</p>
                                <form data-form="generate-invite">
                                    <button type="submit" class="btn btn-primary w-full">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                        </svg>
                                        Generate Invite Code
                                    </button>
                                </form>
                            </div>

                            <!-- Accept Invite -->
                            <div class="mb-6 p-4 bg-green-50 rounded-lg">
                                <h4 class="font-medium mb-2">Join Someone</h4>
                                <p class="text-sm text-gray-600 mb-3">Enter an invite code to connect with someone.</p>
                                <form data-form="accept-invite">
                                    <div class="flex space-x-2">
                                        <input type="text" name="inviteCode" placeholder="Enter invite code" required
                                            class="flex-1 form-input" style="min-height: 40px;">
                                        <button type="submit" class="btn btn-success">
                                            Join
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <div class="mt-6">
                                <button data-action="close-modal" class="w-full btn btn-secondary">
                                    Close
                                </button>
                            </div>
                        `;

                    case 'income':
                        return `
                            <h3 class="text-xl font-bold mb-4">${itemId ? 'Edit' : 'Add'} Income</h3>
                            <form data-form="${itemId ? 'edit-income' : 'add-income'}">
                                ${itemId ? `<input type="hidden" name="id" value="${itemId}">` : ''}
                                <div class="space-y-4">
                                    <input type="text" name="source" placeholder="Income Source" required
                                        class="form-input">
                                    <input type="number" name="amount" placeholder="Amount" step="0.01" required
                                        class="form-input">
                                    <select name="frequency" class="form-input">
                                        <option value="monthly">Monthly</option>
                                        <option value="bi-weekly">Bi-weekly</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="one-time">One-time</option>
                                    </select>
                                    <select name="type" class="form-input">
                                        <option value="salary">Salary</option>
                                        <option value="freelance">Freelance</option>
                                        <option value="investment">Investment</option>
                                        <option value="other">Other</option>
                                    </select>
                                    <div class="grid grid-cols-2 gap-3">
                                        <button type="submit" class="btn btn-primary">
                                            ${itemId ? 'Update' : 'Add'} Income
                                        </button>
                                        <button type="button" data-action="close-modal" class="btn btn-secondary">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </form>
                        `;

                    case 'bill':
                        return `
                            <h3 class="text-xl font-bold mb-4">${itemId ? 'Edit' : 'Add'} Bill</h3>
                            <form data-form="${itemId ? 'edit-bill' : 'add-bill'}">
                                ${itemId ? `<input type="hidden" name="id" value="${itemId}">` : ''}
                                <div class="space-y-4">
                                    <input type="text" name="name" placeholder="Bill Name" required
                                        class="form-input">
                                    <input type="number" name="amount" placeholder="Total Amount" step="0.01" required
                                        class="form-input">
                                    <input type="date" name="dueDate" required
                                        class="form-input">
                                    <select name="category" class="form-input">
                                        <option value="utilities">Utilities</option>
                                        <option value="rent">Rent/Mortgage</option>
                                        <option value="insurance">Insurance</option>
                                        <option value="subscription">Subscription</option>
                                        <option value="loan">Loan</option>
                                        <option value="other">Other</option>
                                    </select>
                                    
                                    <div class="p-4 bg-blue-50 rounded-lg">
                                        <h4 class="font-medium mb-2">Share this bill?</h4>
                                        <select name="shareWith" class="form-input mb-3" onchange="toggleSplitType(this.value)">
                                            <option value="">Just me (no sharing)</option>
                                        </select>
                                        
                                        <div id="split-options" style="display:none;">
                                            <label class="block text-sm font-medium mb-2">How to split:</label>
                                            <div class="space-y-2 mb-3">
                                                <label class="flex items-center">
                                                    <input type="radio" name="splitType" value="equal" checked class="mr-2">
                                                    <span class="text-sm">Split equally</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="radio" name="splitType" value="custom" class="mr-2">
                                                    <span class="text-sm">Custom amounts</span>
                                                </label>
                                            </div>
                                            
                                            <div id="custom-split" style="display:none;">
                                                <label class="block text-sm text-gray-600 mb-1">Your amount:</label>
                                                <input type="number" name="userAmount" placeholder="Your portion" step="0.01" class="form-input">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-3">
                                        <button type="submit" class="btn btn-primary">
                                            ${itemId ? 'Update' : 'Add'} Bill
                                        </button>
                                        <button type="button" data-action="close-modal" class="btn btn-secondary">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </form>
                        `;
                }
            }

            async calculateTotals() {
                const incomes = await storage.getUserIncomes();
                const bills = await storage.getUserBills();

                let monthlyIncome = 0;
                incomes.forEach(income => {
                    switch (income.frequency) {
                        case 'weekly': monthlyIncome += income.amount * 4.33; break;
                        case 'bi-weekly': monthlyIncome += income.amount * 2.17; break;
                        case 'monthly': monthlyIncome += income.amount; break;
                        case 'one-time': monthlyIncome += income.amount / 12; break;
                    }
                });

                let monthlyBills = 0;
                bills.forEach(bill => {
                    if (bill.user_share_amount) {
                        // Use the specific split amount for shared bills
                        monthlyBills += bill.user_share_amount;
                    } else {
                        // Use full amount for personal bills
                        monthlyBills += bill.amount;
                    }
                });

                return {
                    income: monthlyIncome,
                    bills: monthlyBills,
                    remaining: monthlyIncome - monthlyBills
                };
            }

            async render() {
                const app = document.getElementById('app');

                if (this.currentView === 'login') {
                    app.innerHTML = this.renderLogin();
                } else {
                    this.setDataLoading(true);
                    
                    try {
                        const [totals, incomes, bills, notifications] = await Promise.all([
                            this.calculateTotals(),
                            storage.getUserIncomes(),
                            storage.getUserBills(),
                            storage.getUserNotifications()
                        ]);

                        app.innerHTML = this.renderApp(totals, incomes, bills, notifications);
                    } catch (error) {
                        console.error('Error loading data:', error);
                        app.innerHTML = this.renderError();
                    } finally {
                        this.setDataLoading(false);
                    }
                }
            }

            renderLogin() {
                return `
                    <div class="min-h-screen gradient-bg flex items-center justify-center p-4">
                        <div class="glass rounded-2xl shadow-2xl w-full max-w-md p-8">
                            <div class="text-center mb-8">
                                <div class="bg-white bg-opacity-20 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                            d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <h1 class="text-3xl font-bold text-gray-800">Smart Budget</h1>
                                <p class="text-gray-600 mt-2">Your Financial Management Partner</p>
                            </div>

                            <div id="login-form">
                                <form data-form="login">
                                    <div class="space-y-4">
                                        <input type="email" name="email" placeholder="Email" required
                                            class="form-input">
                                        <input type="password" name="password" placeholder="Password" required
                                            class="form-input">
                                        <button type="submit" class="w-full btn btn-primary">
                                            <span class="spinner" style="display: none;"></span>
                                            <span>Log In</span>
                                        </button>
                                    </div>
                                </form>
                                <div class="text-center mt-4">
                                    <button data-action="switch-to-signup" class="text-purple-600 hover:underline btn">
                                        Don't have an account? Sign up
                                    </button>
                                </div>
                            </div>

                            <div id="signup-form" style="display:none;">
                                <form data-form="signup">
                                    <div class="space-y-4">
                                        <input type="text" name="name" placeholder="Full Name" required
                                            class="form-input">
                                        <input type="email" name="email" placeholder="Email" required
                                            class="form-input">
                                        <input type="password" name="password" placeholder="Password" required
                                            class="form-input">
                                        <button type="submit" class="w-full btn btn-primary">
                                            <span class="spinner" style="display: none;"></span>
                                            <span>Create Account</span>
                                        </button>
                                    </div>
                                </form>
                                <div class="text-center mt-4">
                                    <button data-action="switch-to-login" class="text-purple-600 hover:underline btn">
                                        Already have an account? Log in
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mt-6 text-center">
                                <div class="text-xs text-gray-500 bg-white bg-opacity-50 rounded-lg p-2">
                                    <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                            d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                                    </svg>
                                    Cross-device synchronization enabled
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderApp(totals, incomes, bills, notifications) {
                return `
                    <div class="min-h-screen bg-gray-50">
                        <!-- Header -->
                        <header class="gradient-bg text-white shadow-lg sticky top-0 z-40">
                            <div class="max-w-7xl mx-auto px-4 py-4">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center space-x-4">
                                        <div class="bg-white bg-opacity-20 p-2 rounded-lg">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                        </div>
                                        <div>
                                            <h1 class="text-xl font-bold">Smart Budget</h1>
                                            <p class="text-sm opacity-90">Welcome, ${this.currentUser?.name || 'User'}</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <button class="${notifications.length > 0 ? 'notification-dot relative' : ''} btn p-2">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                                            </svg>
                                        </button>
                                        <button data-action="toggle-private" class="btn p-2">
                                            ${this.privateMode ? 
                                                '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path></svg>' :
                                                '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>'
                                            }
                                        </button>
                                        <button data-action="logout" class="btn p-2">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </header>

                        <!-- Navigation Tabs -->
                        <div class="bg-white shadow-sm border-b sticky top-16 z-30">
                            <div class="max-w-7xl mx-auto">
                                <div class="flex space-x-4 px-4">
                                    ${['dashboard', 'income', 'bills', 'connections'].map(tab => `
                                        <button data-action="switch-tab" data-tab="${tab}" 
                                            class="btn py-4 px-4 border-b-2 font-medium text-sm transition whitespace-nowrap ${
                                                this.activeTab === tab 
                                                    ? 'border-purple-600 text-purple-600' 
                                                    : 'border-transparent text-gray-500 hover:text-gray-700'
                                            }">
                                            ${tab.charAt(0).toUpperCase() + tab.slice(1)}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Main Content -->
                        <div class="max-w-7xl mx-auto p-4">
                            ${this.renderMainContent(totals, incomes, bills, notifications)}
                        </div>
                    </div>
                `;
            }

            renderMainContent(totals, incomes, bills, notifications) {
                // Notifications
                let notificationsHtml = '';
                if (notifications.length > 0) {
                    notificationsHtml = `
                        <div class="mb-4 space-y-2">
                            ${notifications.map(n => `
                                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 flex justify-between items-center fade-in rounded-lg">
                                    <div class="flex items-center">
                                        <svg class="w-5 h-5 text-yellow-600 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                        </svg>
                                        <span class="text-sm">${n.message}</span>
                                    </div>
                                    <button data-action="dismiss-notification" data-notification-id="${n.id}" 
                                        class="btn p-2 text-yellow-600 hover:text-yellow-800">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                switch (this.activeTab) {
                    case 'dashboard':
                        return notificationsHtml + `
                            <div class="space-y-6 fade-in">
                                <!-- Summary Cards -->
                                <div class="grid-responsive">
                                    <div class="card card-mobile">
                                        <div class="flex items-center justify-between mb-2">
                                            <h3 class="text-gray-600 text-sm font-medium">Monthly Income</h3>
                                            <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                                            </svg>
                                        </div>
                                        <p class="text-2xl font-bold ${this.privateMode ? 'filter blur-sm' : ''}">
                                            $${totals.income.toFixed(2)}
                                        </p>
                                    </div>
                                    
                                    <div class="card card-mobile">
                                        <div class="flex items-center justify-between mb-2">
                                            <h3 class="text-gray-600 text-sm font-medium">Monthly Bills</h3>
                                            <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                    d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                                            </svg>
                                        </div>
                                        <p class="text-2xl font-bold">
                                            $${totals.bills.toFixed(2)}
                                        </p>
                                    </div>
                                    
                                    <div class="card card-mobile">
                                        <div class="flex items-center justify-between mb-2">
                                            <h3 class="text-gray-600 text-sm font-medium">Remaining</h3>
                                            <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                    d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                            </svg>
                                        </div>
                                        <p class="text-2xl font-bold ${totals.remaining >= 0 ? 'text-green-600' : 'text-red-600'} ${this.privateMode ? 'filter blur-sm' : ''}">
                                            $${totals.remaining.toFixed(2)}
                                        </p>
                                    </div>
                                </div>

                                <!-- Credit Score -->
                                <div class="card p-6">
                                    <h3 class="text-lg font-bold mb-4">Credit Score</h3>
                                    <div class="flex items-center space-x-6">
                                        <div class="text-center">
                                            <div class="text-4xl font-bold ${
                                                (this.currentUser?.credit_score || 700) >= 750 ? 'text-green-600' : 
                                                (this.currentUser?.credit_score || 700) >= 650 ? 'text-yellow-600' : 'text-red-600'
                                            }">
                                                ${this.currentUser?.credit_score || 700}
                                            </div>
                                            <p class="text-sm text-gray-600 mt-1">
                                                ${(this.currentUser?.credit_score || 700) >= 750 ? 'Excellent' : 
                                                 (this.currentUser?.credit_score || 700) >= 650 ? 'Good' : 'Fair'}
                                            </p>
                                        </div>
                                        <div class="flex-1">
                                            <div class="bg-gray-200 rounded-full h-4">
                                                <div class="h-4 rounded-full transition-all duration-500 ${
                                                    (this.currentUser?.credit_score || 700) >= 750 ? 'bg-green-600' : 
                                                    (this.currentUser?.credit_score || 700) >= 650 ? 'bg-yellow-600' : 'bg-red-600'
                                                }" style="width: ${(((this.currentUser?.credit_score || 700) - 300) / 550) * 100}%"></div>
                                            </div>
                                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                                <span>300</span>
                                                <span>850</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quick Actions -->
                                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                    <button data-action="show-modal" data-modal="income" 
                                        class="card card-mobile hover:shadow-lg transition flex flex-col items-center space-y-2 btn">
                                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                        </svg>
                                        <span class="text-sm font-medium">Add Income</span>
                                    </button>
                                    
                                    <button data-action="show-modal" data-modal="bill" 
                                        class="card card-mobile hover:shadow-lg transition flex flex-col items-center space-y-2 btn">
                                        <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                        </svg>
                                        <span class="text-sm font-medium">Add Bill</span>
                                    </button>
                                    
                                    <button data-action="show-modal" data-modal="connections" 
                                        class="card card-mobile hover:shadow-lg transition flex flex-col items-center space-y-2 btn">
                                        <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z" />
                                        </svg>
                                        <span class="text-sm font-medium">Connect</span>
                                    </button>
                                    
                                    <button class="card card-mobile hover:shadow-lg transition flex flex-col items-center space-y-2 btn opacity-50 cursor-not-allowed">
                                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                                        </svg>
                                        <span class="text-sm font-medium">Link Account</span>
                                    </button>
                                </div>
                            </div>
                        `;

                    case 'income':
                        return notificationsHtml + `
                            <div class="card fade-in">
                                <div class="p-6 border-b flex justify-between items-center">
                                    <h2 class="text-xl font-bold">Income Sources</h2>
                                    <button data-action="show-modal" data-modal="income" 
                                        class="btn btn-primary">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                        </svg>
                                        <span>Add Income</span>
                                    </button>
                                </div>
                                <div class="p-6">
                                    ${incomes.length === 0 ? `
                                        <div class="text-center py-12">
                                            <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            <p class="text-gray-500">No income sources added yet</p>
                                            <p class="text-sm text-gray-400 mt-2">Add your income sources to start tracking</p>
                                        </div>
                                    ` : `
                                        <div class="space-y-3">
                                            ${incomes.map(income => `
                                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                                    <div class="flex items-center space-x-4">
                                                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                            </svg>
                                                        </div>
                                                        <div class="flex-1">
                                                            <p class="font-medium">${income.source}</p>
                                                            <p class="text-sm text-gray-600">
                                                                ${income.type}  ${income.frequency}
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <div class="flex items-center space-x-2">
                                                        <p class="text-lg font-bold text-green-600 ${this.privateMode ? 'filter blur-sm' : ''}">
                                                            $${income.amount.toFixed(2)}
                                                        </p>
                                                        <div class="flex space-x-1">
                                                            <button data-action="show-modal" data-modal="income" data-id="${income.id}" 
                                                                class="btn p-2 text-blue-600 hover:text-blue-800">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                                </svg>
                                                            </button>
                                                            <button data-action="delete-income" data-income-id="${income.id}" 
                                                                class="btn p-2 text-red-600 hover:text-red-800">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                                </svg>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    `}
                                </div>
                            </div>
                        `;

                    case 'bills':
                        return notificationsHtml + `
                            <div class="card fade-in">
                                <div class="p-6 border-b flex justify-between items-center">
                                    <h2 class="text-xl font-bold">Bills & Payments</h2>
                                    <button data-action="show-modal" data-modal="bill" 
                                        class="btn btn-primary">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                        </svg>
                                        <span>Add Bill</span>
                                    </button>
                                </div>
                                <div class="p-6">
                                    ${bills.length === 0 ? `
                                        <div class="text-center py-12">
                                            <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                            </svg>
                                            <p class="text-gray-500">No bills added yet</p>
                                            <p class="text-sm text-gray-400 mt-2">Add your bills to track due dates and payments</p>
                                        </div>
                                    ` : `
                                        <div class="space-y-3">
                                            ${bills.map(bill => {
                                                const isShared = bill.is_shared_with_me || (bill.bill_shares && bill.bill_shares.length > 1);
                                                const userAmount = bill.user_share_amount || bill.amount;
                                                
                                                return `
                                                <div class="p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                                    <div class="flex items-center justify-between mb-3">
                                                        <div class="flex items-center space-x-4 flex-1">
                                                            <div class="w-10 h-10 ${bill.paid ? 'bg-green-100' : 'bg-red-100'} rounded-full flex items-center justify-center">
                                                                <svg class="w-6 h-6 ${bill.paid ? 'text-green-600' : 'text-red-600'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    ${bill.paid ? 
                                                                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />' :
                                                                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />'
                                                                    }
                                                                </svg>
                                                            </div>
                                                            <div class="flex-1">
                                                                <div class="flex items-center space-x-2 mb-1">
                                                                    <p class="font-medium">${bill.name}</p>
                                                                    ${isShared ? 
                                                                        '<span class="shared-indicator">Shared</span>' : 
                                                                        '<span class="personal-indicator">Personal</span>'
                                                                    }
                                                                </div>
                                                                <p class="text-sm text-gray-600">
                                                                    Due: ${new Date(bill.due_date).toLocaleDateString()}  ${bill.category}
                                                                </p>
                                                                ${isShared ? `
                                                                    <p class="text-sm text-purple-600 flex items-center mt-1">
                                                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                                                                        </svg>
                                                                        ${bill.is_shared_with_me ? 'Shared with you' : 'Shared bill'}
                                                                    </p>
                                                                ` : ''}
                                                            </div>
                                                        </div>
                                                        <div class="flex items-center space-x-3">
                                                            <div class="text-right">
                                                                <p class="text-lg font-bold">
                                                                    $${userAmount.toFixed(2)}
                                                                </p>
                                                                ${isShared && bill.amount !== userAmount ? `
                                                                    <p class="text-xs text-gray-500">Total: $${bill.amount.toFixed(2)}</p>
                                                                ` : ''}
                                                            </div>
                                                            ${!bill.is_shared_with_me ? `
                                                                <div class="flex space-x-1">
                                                                    <button data-action="show-modal" data-modal="bill" data-id="${bill.id}" 
                                                                        class="btn p-2 text-blue-600 hover:text-blue-800">
                                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                                        </svg>
                                                                    </button>
                                                                    <button data-action="delete-bill" data-bill-id="${bill.id}" 
                                                                        class="btn p-2 text-red-600 hover:text-red-800">
                                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                                        </svg>
                                                                    </button>
                                                                </div>
                                                            ` : ''}
                                                        </div>
                                                    </div>
                                                    ${!bill.paid ? `
                                                        <button data-action="mark-paid" data-bill-id="${bill.id}" 
                                                            class="w-full mt-3 btn btn-success">
                                                            Mark as Paid
                                                        </button>
                                                    ` : `
                                                        <div class="mt-3 text-center text-green-600 font-medium">
                                                             Paid on ${new Date(bill.paid_date).toLocaleDateString()}
                                                        </div>
                                                    `}
                                                </div>
                                            `;
                                            }).join('')}
                                        </div>
                                    `}
                                </div>
                            </div>
                        `;

                    case 'connections':
                        return notificationsHtml + this.renderConnectionsTab();

                    default:
                        return notificationsHtml + `<div class="text-center py-12 text-gray-500">Invalid tab</div>`;
                }
            }

            async renderConnectionsTab() {
                const connections = await storage.getUserConnections();
                const bills = await storage.getUserBills();
                const sharedBills = bills.filter(bill => bill.is_shared_with_me || (bill.bill_shares && bill.bill_shares.length > 1));
                
                return `
                    <div class="space-y-6 fade-in">
                        <!-- Connection Management Card -->
                        <div class="card">
                            <div class="p-6 border-b flex justify-between items-center">
                                <h2 class="text-xl font-bold">Connections</h2>
                                <button data-action="show-modal" data-modal="connections" 
                                    class="btn btn-primary">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z" />
                                    </svg>
                                    <span>Manage Connections</span>
                                </button>
                            </div>
                            <div class="p-6">
                                ${connections.length === 0 ? `
                                    <div class="text-center py-12">
                                        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z" />
                                        </svg>
                                        <p class="text-gray-500">No connections yet</p>
                                        <p class="text-sm text-gray-400 mt-2">Connect with family or roommates to share bills</p>
                                    </div>
                                ` : `
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        ${connections.map(connection => {
                                            const connectionSharedBills = sharedBills.filter(bill => 
                                                bill.bill_shares && bill.bill_shares.some(share => share.user_id === connection.id)
                                            );
                                            
                                            return `
                                                <div class="bg-gray-50 rounded-lg p-4">
                                                    <div class="flex items-center space-x-3 mb-3">
                                                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                                            </svg>
                                                        </div>
                                                        <div class="flex-1">
                                                            <p class="font-medium">${connection.name}</p>
                                                            <p class="text-sm text-gray-600">${connection.email}</p>
                                                        </div>
                                                        <span class="connection-badge connection-active">
                                                            Connected
                                                        </span>
                                                    </div>
                                                    
                                                    <div class="text-sm text-gray-600 mb-2">
                                                        <p><strong>${connectionSharedBills.length}</strong> shared bills</p>
                                                    </div>
                                                    
                                                    ${connectionSharedBills.length > 0 ? `
                                                        <div class="space-y-1 mb-3">
                                                            ${connectionSharedBills.slice(0, 3).map(bill => `
                                                                <div class="flex justify-between text-xs">
                                                                    <span>${bill.name}</span>
                                                                    <span class="font-medium">${(bill.user_share_amount || bill.amount).toFixed(2)}</span>
                                                                </div>
                                                            `).join('')}
                                                            ${connectionSharedBills.length > 3 ? `
                                                                <div class="text-xs text-gray-500">
                                                                    +${connectionSharedBills.length - 3} more bills
                                                                </div>
                                                            ` : ''}
                                                        </div>
                                                    ` : ''}
                                                    
                                                    <button data-action="remove-connection" data-connection-id="${connection.id}" 
                                                        class="w-full btn btn-danger text-sm py-2">
                                                        Remove Connection
                                                    </button>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                `}
                            </div>
                        </div>

                        <!-- Shared Bills Summary -->
                        ${sharedBills.length > 0 ? `
                            <div class="card">
                                <div class="p-6 border-b">
                                    <h3 class="text-lg font-bold">Shared Bills Summary</h3>
                                </div>
                                <div class="p-6">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        ${connections.map(connection => {
                                            const connectionBills = sharedBills.filter(bill => 
                                                bill.bill_shares && bill.bill_shares.some(share => share.user_id === connection.id)
                                            );
                                            const totalShared = connectionBills.reduce((sum, bill) => 
                                                sum + (bill.user_share_amount || bill.amount), 0
                                            );
                                            
                                            return connectionBills.length > 0 ? `
                                                <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-4">
                                                    <div class="flex items-center justify-between mb-3">
                                                        <h4 class="font-medium">With ${connection.name}</h4>
                                                        <span class="text-lg font-bold text-green-600">
                                                            ${totalShared.toFixed(2)}
                                                        </span>
                                                    </div>
                                                    <div class="space-y-2">
                                                        ${connectionBills.map(bill => `
                                                            <div class="flex justify-between text-sm">
                                                                <span class="flex items-center">
                                                                    ${bill.name}
                                                                    ${bill.paid ? 
                                                                        '<svg class="w-4 h-4 ml-1 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' :
                                                                        '<svg class="w-4 h-4 ml-1 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
                                                                    }
                                                                </span>
                                                                <span class="font-medium">
                                                                    ${(bill.user_share_amount || bill.amount).toFixed(2)}
                                                                </span>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            ` : '';
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            renderError() {
                return `
                    <div class="min-h-screen gradient-bg flex items-center justify-center p-4">
                        <div class="glass rounded-2xl shadow-2xl w-full max-w-md p-8 text-center">
                            <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            <h2 class="text-xl font-bold text-gray-800 mb-2">Something went wrong</h2>
                            <p class="text-gray-600 mb-4">Unable to load your data. Please check your connection and try again.</p>
                            <button onclick="window.location.reload()" class="btn btn-primary">
                                Refresh Page
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Helper functions for dynamic UI
        function toggleSplitType(shareWithValue) {
            const splitOptions = document.getElementById('split-options');
            if (splitOptions) {
                splitOptions.style.display = shareWithValue ? 'block' : 'none';
            }
        }

        // Handle custom split radio change
        document.addEventListener('change', (e) => {
            if (e.target.name === 'splitType') {
                const customSplit = document.getElementById('custom-split');
                if (customSplit) {
                    customSplit.style.display = e.target.value === 'custom' ? 'block' : 'none';
                }
            }
        });

        // Initialize storage and app
        const storage = new SupabaseService();
        const app = new SmartBudgetApp();

        // Make them globally available
        window.storage = storage;
        window.app = app;
    </script>
</body>
</html>
