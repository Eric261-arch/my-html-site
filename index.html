<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Budget - Financial Management App</title>
    <meta name="description" content="Manage your finances, split bills, and track expenses with Smart Budget">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Existing styles unchanged */
    </style>
</head>
<body>
    <div id="offline-banner" class="offline-banner">
        <span>You're offline. Changes will sync when connection is restored.</span>
    </div>
    
    <div id="app"></div>

    <script>
        // Supabase Configuration (unchanged)
        const SUPABASE_URL = 'https://rpagbqdshrywagdnymgf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwYWdicWRzaHJ5d2FnZG55bWdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNjc0OTIsImV4cCI6MjA3MzY0MzQ5Mn0.VKV8kHE8wwgePus2l8DoZusQa8LE3afYbUzFoxwKM2A';

        // Initialize Supabase (unchanged)
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // SupabaseService (updated to use RPC for bills/expenses)
        class SupabaseService {
            // ... All existing methods unchanged, except getUserBills and getUserExpenses ...

            async getUserBills(includeCompleted = false) {
                try {
                    const { data, error } = await supabase.rpc('get_user_bills', {
                        user_id_param: this.user.id,
                        include_completed: includeCompleted
                    });
                    if (error) throw error;
                    return data || [];
                } catch (error) {
                    console.error('Get user bills error:', error);
                    return [];
                }
            }

            async getUserExpenses(includeCompleted = false) {
                try {
                    const { data, error } = await supabase.rpc('get_user_expenses', {
                        user_id_param: this.user.id,
                        include_completed: includeCompleted
                    });
                    if (error) throw error;
                    return data || [];
                } catch (error) {
                    console.error('Get user expenses error:', error);
                    return [];
                }
            }

            // ... Other methods unchanged ...
        }

        // SmartBudgetApp (major updates: history tab, real-time, fixes)
        class SmartBudgetApp {
            constructor() {
                this.currentUser = null;
                this.currentView = 'login';
                this.activeTab = 'dashboard';
                this.privateMode = false;
                this.loading = false;
                this.receiptItems = [];
                this.init();
            }

            async init() {
                const user = await storage.getCurrentUser();
                if (user) {
                    const profile = await storage.getUserProfile();
                    if (profile) {
                        this.currentUser = profile;
                        this.currentView = 'app';
                        this.setupRealtime();  // Add real-time subscriptions
                    }
                }
                this.render();
                this.attachEventListeners();
                window.app = this;
            }

            setupRealtime() {
                supabase.channel('bills-changes')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'bills' }, () => {
                        if (this.currentView === 'app') this.render();
                    })
                    .subscribe();

                supabase.channel('bill_shares-changes')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'bill_shares' }, () => {
                        if (this.currentView === 'app') this.render();
                    })
                    .subscribe();
            }

            // ... attachEventListeners, setLoading, handleAction, addReceiptItem, removeReceiptItem, updateReceiptItemsDisplay, updateReceiptItem unchanged ...

            async calculateTotals() {
                const incomes = await storage.getUserIncomes();
                const bills = await storage.getUserBills();  // Unpaid only (includeCompleted=false)
                const expenses = await storage.getUserExpenses();  // Unpaid only

                let monthlyIncome = 0;
                incomes.forEach(income => {
                    switch(income.frequency) {
                        case 'weekly': monthlyIncome += income.amount * 4.33; break;
                        case 'bi-weekly': monthlyIncome += income.amount * 2.17; break;
                        case 'monthly': monthlyIncome += income.amount; break;
                        case 'one-time': monthlyIncome += income.amount / 12; break;
                    }
                });

                let monthlyBills = 0;
                bills.forEach(bill => {
                    const userPaid = bill.is_shared ? bill.user_paid : bill.creator_paid;
                    if (!userPaid) {
                        monthlyBills += bill.user_share || bill.amount;
                    }
                });

                let pendingExpenses = 0;
                expenses.forEach(expense => {
                    const userPaid = expense.is_shared ? expense.user_paid : expense.creator_paid;
                    if (!userPaid) {
                        pendingExpenses += expense.user_share || expense.amount;
                    }
                });

                return {
                    income: monthlyIncome,
                    bills: monthlyBills,
                    expenses: pendingExpenses,
                    remaining: monthlyIncome - monthlyBills - pendingExpenses
                };
            }

            getBillStatus(bill) {
                if (bill.paid) {
                    return { status: 'Complete', class: 'status-complete' };
                }
                const userPaid = bill.is_shared ? bill.user_paid : bill.creator_paid;
                if (userPaid) {
                    return { status: 'Waiting for others', class: 'status-waiting-others' };
                } else {
                    return { status: 'Waiting for you', class: 'status-waiting-you' };
                }
            }

            // ... Other methods like handleFormSubmit, showError, showSuccess, showModal, closeModal, getModalContent, build*Modal unchanged ...

            async render() {
                const app = document.getElementById('app');
                
                if (this.currentView === 'login') {
                    app.innerHTML = this.renderLogin();
                } else {
                    const totals = await this.calculateTotals();
                    const incomes = await storage.getUserIncomes();
                    const bills = await storage.getUserBills();  // Unpaid
                    const expenses = await storage.getUserExpenses();  // Unpaid
                    const notifications = await storage.getUpcomingBillNotifications();
                    
                    app.innerHTML = this.renderApp(totals, incomes, bills, expenses, notifications);
                }
            }

            renderApp(totals, incomes, bills, expenses, notifications) {
                const userName = this.currentUser?.name || 'User';
                const tabs = ['dashboard', 'income', 'bills', 'expenses', 'history', 'connections'];
                
                let tabsHTML = '';
                for (const tab of tabs) {
                    const activeClass = this.activeTab === tab ? 'border-purple-600 text-purple-600' : 'border-transparent text-gray-500 hover:text-gray-700';
                    const tabName = tab.charAt(0).toUpperCase() + tab.slice(1);
                    let notificationDot = '';
                    
                    if (tab === 'dashboard' && notifications.length > 0) {
                        notificationDot = '<span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">' + notifications.length + '</span>';
                    }
                    
                    tabsHTML += '<button data-action="switch-tab" data-tab="' + tab + '" class="btn py-4 px-4 border-b-2 font-medium text-sm transition whitespace-nowrap relative ' + activeClass + '">' + tabName + notificationDot + '</button>';
                }
                
                const privateModeIcon = this.privateMode ? 
                    '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path></svg>' :
                    '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>';
                
                let mainContent = '';
                switch (this.activeTab) {
                    case 'dashboard':
                        mainContent = this.renderDashboard(totals, notifications);
                        break;
                    case 'income':
                        mainContent = this.renderIncomeTab(incomes);
                        break;
                    case 'bills':
                        mainContent = this.renderBillsTab(bills);
                        break;
                    case 'expenses':
                        mainContent = this.renderExpensesTab(expenses);
                        break;
                    case 'history':
                        mainContent = await this.renderHistoryTab();
                        break;
                    case 'connections':
                        mainContent = this.renderConnectionsTab();
                        break;
                }
                
                return '<div class="min-h-screen bg-gray-50">' +
                    // ... Header and tabs HTML unchanged ...
                    '<div class="max-w-7xl mx-auto p-4">' + mainContent + '</div>' +
                    '</div>';
            }

            // New renderHistoryTab
            async renderHistoryTab() {
                const completedBills = (await storage.getUserBills(true)).filter(b => b.paid);
                const completedExpenses = (await storage.getUserExpenses(true)).filter(e => e.paid);
                const allCompleted = [...completedBills.map(b => ({...b, type: 'bill'})), ...completedExpenses.map(e => ({...e, type: 'expense'}))]
                    .sort((a, b) => new Date(b.paid_date) - new Date(a.paid_date));

                let historyContent = '';
                if (allCompleted.length === 0) {
                    historyContent = '<div class="text-center py-12">' +
                        '<svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />' +
                        '</svg>' +
                        '<p class="text-gray-500">No completed payments yet</p>' +
                        '</div>';
                } else {
                    let list = '';
                    for (const item of allCompleted) {
                        const isShared = item.is_shared;
                        const userAmount = item.user_share || item.amount;
                        const indicators = [];
                        indicators.push(item.type === 'bill' ? '<span class="personal-indicator">Bill</span>' : '<span class="expense-indicator">Expense</span>');
                        if (isShared) indicators.push('<span class="shared-indicator">Shared</span>');
                        else indicators.push('<span class="personal-indicator">Personal</span>');
                        if (item.recurring) indicators.push('<span class="recurring-indicator">Recurring</span>');
                        const totalInfo = isShared && item.amount !== userAmount ? '<p class="text-xs text-gray-500">Total: $' + item.amount.toFixed(2) + '</p>' : '';
                        const paidDate = new Date(item.paid_date).toLocaleDateString();
                        const dateLabel = item.type === 'expense' ? 'Date:' : 'Due:';
                        const dueDate = item.type === 'expense' ? item.expense_date : item.due_date;

                        let receiptHTML = '';
                        if (item.type === 'expense' && item.description) {
                            let items = [];
                            try { items = JSON.parse(item.description); } catch {}
                            if (items.length > 0) {
                                receiptHTML = '<div class="mt-2 text-xs text-gray-600"><p class="font-medium">Items:</p><ul class="list-disc list-inside">';
                                items.forEach(i => receiptHTML += `<li>${i.name} - $${i.amount.toFixed(2)}</li>`);
                                receiptHTML += '</ul></div>';
                            }
                        }

                        list += '<div class="p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">' +
                            '<div class="flex items-center justify-between mb-3">' +
                            '<div class="flex items-center space-x-4 flex-1">' +
                            '<div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">' +
                            '<svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />' +
                            '</svg>' +
                            '</div>' +
                            '<div class="flex-1">' +
                            '<div class="flex items-center space-x-2 mb-1 flex-wrap">' +
                            '<p class="font-medium">' + item.name + '</p>' +
                            indicators.join('') +
                            '</div>' +
                            '<p class="text-sm text-gray-600">' + dateLabel + ' ' + new Date(dueDate).toLocaleDateString() + (item.category ? ' • ' + item.category : '') + '</p>' +
                            receiptHTML +
                            '</div>' +
                            '</div>' +
                            '<div class="flex items-center space-x-3">' +
                            '<div class="text-right">' +
                            '<p class="text-lg font-bold">$' + userAmount.toFixed(2) + '</p>' +
                            totalInfo +
                            '<span class="status-complete">Complete</span>' +
                            '</div>' +
                            '<button data-action="delete-bill" data-bill-id="' + item.bill_id + '" class="btn p-2 text-red-600 hover:text-red-800">' +
                            '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />' +
                            '</svg>' +
                            '</button>' +
                            '</div>' +
                            '</div>' +
                            '<div class="mt-3 text-center text-green-600 font-medium">✓ Complete • ' + paidDate + '</div>' +
                            '</div>';
                    }
                    historyContent = '<div class="space-y-3">' + list + '</div>';
                }

                return '<div class="card fade-in">' +
                    '<div class="p-6 border-b flex justify-between items-center">' +
                    '<h2 class="text-xl font-bold">Payment History</h2>' +
                    '</div>' +
                    '<div class="p-6">' + historyContent + '</div>' +
                    '</div>';
            }

            // Updated renderBillsTab (with overdue indicator, trash always)
            renderBillsTab(bills) {
                let billsContent = '';
                if (bills.length === 0) {
                    billsContent = '<div class="text-center py-12">' +
                        '<svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />' +
                        '</svg>' +
                        '<p class="text-gray-500">No bills added yet</p>' +
                        '<p class="text-sm text-gray-400 mt-2">Add your bills to track due dates and payments</p>' +
                        '</div>';
                } else {
                    let billsList = '';
                    for (const bill of bills) {
                        const isShared = bill.is_shared;
                        const userAmount = bill.user_share || bill.amount;
                        const status = this.getBillStatus(bill);
                        const indicators = [];
                        if (isShared) indicators.push('<span class="shared-indicator">Shared</span>');
                        else indicators.push('<span class="personal-indicator">Personal</span>');
                        if (bill.recurring) indicators.push('<span class="recurring-indicator">Recurring</span>');
                        const totalInfo = isShared && bill.amount !== userAmount ? '<p class="text-xs text-gray-500">Total: $' + bill.amount.toFixed(2) + '</p>' : '';
                        const overdue = new Date(bill.due_date) < new Date() && !bill.paid;
                        const overdueIcon = overdue ? '<span class="text-red-500">❗</span>' : '';
                        let actionButton = '';
                        if (status.status === 'Complete') {
                            actionButton = '<div class="mt-3 text-center text-green-600 font-medium">✓ Complete' + (bill.paid_date ? ' • ' + new Date(bill.paid_date).toLocaleDateString() : '') + '</div>';
                        } else if (status.status === 'Waiting for others') {
                            actionButton = '<div class="mt-3 text-center text-orange-600 font-medium">⏳ Waiting for others to pay</div>';
                        } else {
                            const shareId = bill.share_id || null;
                            actionButton = '<button data-action="mark-paid" data-bill-id="' + bill.bill_id + '" data-shared="' + isShared + '" data-share-id="' + shareId + '" class="w-full mt-3 btn btn-success">Mark as Paid</button>';
                        }

                        billsList += '<div class="p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">' +
                            '<div class="flex items-center justify-between mb-3">' +
                            '<div class="flex items-center space-x-4 flex-1">' +
                            overdueIcon +
                            '<div class="w-10 h-10 ' + (status.class.includes('complete') ? 'bg-green-100' : 'bg-red-100') + ' rounded-full flex items-center justify-center">' +
                            // ... Icon based on status unchanged ...
                            '</div>' +
                            '<div class="flex-1">' +
                            '<div class="flex items-center space-x-2 mb-1 flex-wrap">' +
                            '<p class="font-medium">' + bill.name + '</p>' +
                            indicators.join('') +
                            '</div>' +
                            '<p class="text-sm text-gray-600">Due: ' + new Date(bill.due_date).toLocaleDateString() + ' • ' + bill.category + '</p>' +
                            (bill.recurring ? '<p class="text-xs text-purple-600">Repeats ' + bill.recurrence_interval + '</p>' : '') +
                            '</div>' +
                            '</div>' +
                            '<div class="flex items-center space-x-3">' +
                            '<div class="text-right">' +
                            '<p class="text-lg font-bold">$' + userAmount.toFixed(2) + '</p>' +
                            totalInfo +
                            '<span class="' + status.class + '">' + status.status + '</span>' +
                            '</div>' +
                            '<button data-action="delete-bill" data-bill-id="' + bill.bill_id + '" class="btn p-2 text-red-600 hover:text-red-800">' +
                            // Trash icon unchanged ...
                            '</button>' +
                            '</div>' +
                            '</div>' +
                            actionButton +
                            '</div>';
                    }
                    billsContent = '<div class="space-y-3">' + billsList + '</div>';
                }
                
                return '<div class="card fade-in">' +
                    '<div class="p-6 border-b flex justify-between items-center">' +
                    '<h2 class="text-xl font-bold">Bills & Payments</h2>' +
                    '<button data-action="show-modal" data-modal="bill" class="btn btn-primary">' +
                    // ... Add Bill button unchanged ...
                    '</button>' +
                    '</div>' +
                    '<div class="p-6">' + billsContent + '</div>' +
                    '</div>';
            }

            // Updated renderExpensesTab (similar fixes)
            renderExpensesTab(expenses) {
                let expensesContent = '';
                if (expenses.length === 0) {
                    // ... No expenses content unchanged ...
                } else {
                    let expensesList = '';
                    for (const expense of expenses) {
                        const isShared = expense.is_shared;
                        const userAmount = expense.user_share || expense.amount;
                        const status = this.getBillStatus(expense);
                        const indicators = [];
                        indicators.push('<span class="expense-indicator">Expense</span>');
                        if (isShared) indicators.push('<span class="shared-indicator">Shared</span>');
                        else indicators.push('<span class="personal-indicator">Personal</span>');
                        const totalInfo = isShared && expense.amount !== userAmount ? '<p class="text-xs text-gray-500">Total: $' + expense.amount.toFixed(2) + '</p>' : '';
                        const overdue = new Date(expense.expense_date) < new Date() && !expense.paid;
                        const overdueIcon = overdue ? '<span class="text-red-500">❗</span>' : '';
                        let receiptHTML = '';
                        if (expense.description) {
                            let items = [];
                            try { items = JSON.parse(expense.description); } catch {}
                            if (items.length > 0) {
                                receiptHTML = '<div class="mt-2 text-xs text-gray-600"><p class="font-medium">Items:</p><ul class="list-disc list-inside">';
                                items.forEach(i => receiptHTML += `<li>${i.name} - $${i.amount.toFixed(2)}</li>`);
                                receiptHTML += '</ul></div>';
                            }
                        }
                        let actionButton = '';
                        if (status.status === 'Complete') {
                            actionButton = '<div class="mt-3 text-center text-green-600 font-medium">✓ Complete' + (expense.paid_date ? ' • ' + new Date(expense.paid_date).toLocaleDateString() : '') + '</div>';
                        } else if (status.status === 'Waiting for others') {
                            actionButton = '<div class="mt-3 text-center text-orange-600 font-medium">⏳ Waiting for others to pay</div>';
                        } else {
                            const shareId = expense.share_id || null;
                            actionButton = '<button data-action="mark-paid" data-bill-id="' + expense.expense_id + '" data-shared="' + isShared + '" data-share-id="' + shareId + '" class="w-full mt-3 btn btn-success">Mark as Paid</button>';
                        }

                        expensesList += '<div class="p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">' +
                            '<div class="flex items-center justify-between mb-3">' +
                            '<div class="flex items-center space-x-4 flex-1">' +
                            overdueIcon +
                            '<div class="w-10 h-10 ' + (status.class.includes('complete') ? 'bg-green-100' : 'bg-orange-100') + ' rounded-full flex items-center justify-center">' +
                            // ... Icon based on status ...
                            '</div>' +
                            '<div class="flex-1">' +
                            '<div class="flex items-center space-x-2 mb-1 flex-wrap">' +
                            '<p class="font-medium">' + expense.name + '</p>' +
                            indicators.join('') +
                            '</div>' +
                            '<p class="text-sm text-gray-600">Date: ' + new Date(expense.expense_date).toLocaleDateString() + '</p>' +
                            receiptHTML +
                            '</div>' +
                            '</div>' +
                            '<div class="flex items-center space-x-3">' +
                            '<div class="text-right">' +
                            '<p class="text-lg font-bold">$' + userAmount.toFixed(2) + '</p>' +
                            totalInfo +
                            '<span class="' + status.class + '">' + status.status + '</span>' +
                            '</div>' +
                            '<button data-action="delete-bill" data-bill-id="' + expense.expense_id + '" class="btn p-2 text-red-600 hover:text-red-800">' +
                            // Trash icon ...
                            '</button>' +
                            '</div>' +
                            '</div>' +
                            actionButton +
                            '</div>';
                    }
                    expensesContent = '<div class="space-y-3">' + expensesList + '</div>';
                }
                
                return '<div class="card fade-in">' +
                    '<div class="p-6 border-b flex justify-between items-center">' +
                    '<h2 class="text-xl font-bold">Expenses</h2>' +
                    '<button data-action="show-modal" data-modal="expense" class="btn btn-primary">' +
                    // ... Add Expense button unchanged ...
                    '</button>' +
                    '</div>' +
                    '<div class="p-6">' + expensesContent + '</div>' +
                    '</div>';
            }

            // ... renderDashboard, renderIncomeTab, renderConnectionsTab unchanged ...
        }

        // ... Helper functions, window attachments unchanged ...

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const app = new SmartBudgetApp();
                // ... Update receipt display unchanged ...
            }, 100);
        });
    </script>
</body>
</html>
